<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harmony V7.1 (Cloud Sync)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Firebase SDKs (Compat version for broader support) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #F8FAFC; color: #334155; -webkit-tap-highlight-color: transparent; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); padding: 1.25rem; margin-bottom: 1rem; border: 1px solid #f1f5f9; transition: all 0.2s; }
        .card:active { transform: scale(0.99); background-color: #fafafa; }
        .btn-primary { background: linear-gradient(135deg, #0f172a 0%, #334155 100%); color: white; font-weight: bold; padding: 0.75rem; border-radius: 0.5rem; width: 100%; transition: opacity 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-primary:active { opacity: 0.9; transform: translateY(1px); }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 5px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Markdown Styling */
        .prose h3 { color: #be185d; font-weight: 700; margin-top: 0.8em; margin-bottom: 0.4em; font-size: 0.95em; }
        .prose strong { color: #1e293b; font-weight: 700; background: linear-gradient(to right, #fecdd3 0%, #fecdd3 100%); background-position: 0 90%; background-size: 100% 30%; background-repeat: no-repeat;}
        .prose ul { list-style-type: none; padding-left: 0; margin-bottom: 0.5em; font-size: 0.9em; }
        .prose li::before { content: "â€¢ "; color: #be185d; font-weight: bold; }
        .prose p { margin-bottom: 0.5em; font-size: 0.9em; line-height: 1.6; }

        /* Login Modal */
        #auth-modal { backdrop-filter: blur(8px); background-color: rgba(0,0,0,0.6); }
    </style>
</head>
<body class="pb-24">

    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-md sticky top-0 z-40 border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-2">
            <h1 class="font-bold text-slate-800 text-lg tracking-tight">Harmony V7.1</h1>
            <div id="status-container" class="flex items-center gap-1">
                <span id="status-indicator" class="w-2 h-2 rounded-full bg-orange-400 animate-pulse"></span>
                <span id="status-text" class="text-[10px] text-slate-400">è¿æ¥ä¸­...</span>
            </div>
        </div>
        <button onclick="showAuthModal()" class="text-xs bg-slate-100 text-slate-600 border border-slate-200 px-3 py-1.5 rounded-full font-medium">
            â˜ï¸ äº‘ç«¯åŒæ­¥
        </button>
    </header>

    <!-- AUTH MODAL (Cloud Sync) -->
    <div id="auth-modal" class="fixed inset-0 z-[100] flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-2xl w-11/12 max-w-sm shadow-2xl transform transition-all scale-100">
            <div class="text-center mb-6">
                <h3 class="text-xl font-bold text-slate-800">â˜ï¸ äº‘ç«¯åŒæ­¥è®¾ç½®</h3>
                <p class="text-xs text-slate-500 mt-1">åœ¨ä¸€å°è®¾å¤‡ä¿å­˜ï¼Œè·¨è®¾å¤‡è‡ªåŠ¨åŒæ­¥ API Key</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-600 ml-1">åŒæ­¥è´¦å· (è‡ªå®šä¹‰):</label>
                    <input type="text" id="sync-id" placeholder="ä¾‹: David_Love_2025" class="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none text-sm font-mono">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-600 ml-1">åŒæ­¥å¯†ç :</label>
                    <input type="password" id="sync-pin" placeholder="è®¾ç½®ä¸€ä¸ªç®€å•å¯†ç " class="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                </div>
                
                <div id="key-section" class="hidden bg-yellow-50 p-3 rounded-xl border border-yellow-100">
                    <label class="text-xs font-bold text-yellow-800 ml-1">ğŸ”‘ Gemini API Key:</label>
                    <input type="password" id="api-key-input" placeholder="ç²˜è´´ AIza å¼€å¤´çš„ Key" class="w-full p-2 border border-yellow-200 rounded-lg bg-white text-xs mt-1">
                    <p class="text-[10px] text-yellow-600 mt-1">é¦–æ¬¡ä½¿ç”¨éœ€è¾“å…¥ï¼Œä¹‹åè‡ªåŠ¨åŒæ­¥ã€‚</p>
                </div>

                <div class="flex gap-3 mt-2">
                    <button onclick="closeAuthModal()" class="flex-1 py-3 text-slate-500 font-bold text-sm">å–æ¶ˆ</button>
                    <button onclick="handleCloudSync()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm shadow-lg hover:bg-blue-700">ç¡®è®¤ / åŒæ­¥</button>
                </div>
                <p id="auth-msg" class="text-center text-xs text-red-500 h-4"></p>
            </div>
        </div>
    </div>

    <main class="max-w-md mx-auto px-4 mt-6 space-y-8">

        <!-- 1. Message (Enhanced) -->
        <section>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-2xl">ğŸ’Œ</span>
                <div>
                    <h2 class="font-bold text-slate-800 text-lg">æš–å¿ƒä¿¡ä½¿ (Message)</h2>
                    <p class="text-[10px] text-slate-400">å«è¡ŒåŠ¨æŒ‡å—</p>
                </div>
            </div>
            <div class="card border-l-4 border-pink-500 bg-gradient-to-br from-white to-pink-50/30">
                <select id="msgContext" class="w-full p-3 border border-slate-200 rounded-xl mb-3 text-sm bg-white outline-none focus:border-pink-500">
                    <option value="post_sex_cold">ğŸ›Œ è´¤è€…æ—¶é—´ï¼šæ‰“ç ´å†·æ·¡ï¼Œå»ºç«‹è¿æ¥</option>
                    <option value="wife_stressed_work">ğŸ¤¯ å¥¹å·¥ä½œå‹åŠ›å¤§ï¼šç»™äºˆæ”¯æŒ</option>
                    <option value="wfh_lunch">ğŸ  WFH åˆé—´ï¼šæ‰“ç ´å®¤å‹æ„Ÿ</option>
                    <option value="apology_ignore">ğŸ˜“ å¿™ç¢Œå¿½ç•¥äº†å¥¹ï¼šçœŸè¯šè¡¥æ•‘</option>
                    <option value="random_love">ğŸ’– æ²¡ä»€ä¹ˆåŸå› ï¼šæ—¥å¸¸æ’©æ‹¨</option>
                </select>
                <button onclick="runGemini('message')" class="btn-primary bg-pink-600 shadow-pink-200">
                    âœ¨ ç”Ÿæˆè¯æœ¯ + é…å¥—è¡ŒåŠ¨
                </button>
                <div id="result-message" class="mt-4 hidden bg-white p-4 rounded-xl border border-pink-100 text-sm shadow-sm relative">
                    <div id="content-message" class="prose prose-sm"></div>
                </div>
            </div>
        </section>

        <!-- 2. Deep Talk -->
        <section>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-2xl">ğŸ—£ï¸</span>
                <h2 class="font-bold text-slate-800 text-lg">æ·±åº¦è¯é¢˜ (Deep Talk)</h2>
            </div>
            <div class="card border-l-4 border-teal-500 bg-gradient-to-br from-white to-teal-50/30">
                <select id="topicVibe" class="w-full p-3 border border-slate-200 rounded-xl mb-3 text-sm bg-white outline-none focus:border-teal-500">
                    <option value="relaxed">ğŸŒ™ ç¡å‰è½»æ¾ (Fun & Light)</option>
                    <option value="nostalgic">ğŸ“¸ æ€€æ—§å›å¿† (Memory Lane)</option>
                    <option value="future">ğŸš€ æœªæ¥æ¢¦æƒ³ (Dreams)</option>
                    <option value="appreciation">ğŸ™ äº’ç›¸æ„Ÿè°¢ (Gratitude)</option>
                </select>
                <button onclick="runGemini('deeptalk')" class="btn-primary bg-teal-600 shadow-teal-200">
                    âœ¨ è·å–çµé­‚è¯é¢˜
                </button>
                <div id="result-deeptalk" class="mt-4 hidden bg-white p-4 rounded-xl border border-teal-100 text-sm text-center font-medium shadow-sm">
                    <p id="content-deeptalk"></p>
                </div>
            </div>
        </section>

        <!-- 3. Booster -->
        <section>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-2xl">ğŸ”¥</span>
                <h2 class="font-bold text-slate-800 text-lg">äº²å¯†å‡çº§ (Booster)</h2>
            </div>
            <div class="card border-l-4 border-rose-600 bg-gradient-to-br from-white to-rose-50/30">
                <select id="boosterGoal" class="w-full p-3 border border-slate-200 rounded-xl mb-3 text-sm bg-white outline-none focus:border-rose-500">
                    <option value="aftercare">ğŸ›Œ æ€§çˆ±åï¼šè®©å¿ƒæ›´é¥±æ»¡ (Aftercare)</option>
                    <option value="during_sex_talk">ğŸ’¬ æ€§çˆ±ä¸­ï¼šèŠä»€ä¹ˆæ‹‰è¿‘è·ç¦»ï¼Ÿ</option>
                    <option value="passive_to_active">ğŸ’ƒ é•¿æœŸï¼šå¦‚ä½•è®©å¥¹å˜ä¸»åŠ¨ï¼Ÿ</option>
                </select>
                <button onclick="runGemini('booster')" class="btn-primary bg-rose-600 shadow-rose-200">
                    âœ¨ è·å–å¤§å¸ˆå»ºè®®
                </button>
                <div id="result-booster" class="mt-4 hidden bg-white p-4 rounded-xl border border-rose-100 text-sm shadow-sm">
                    <div id="content-booster" class="prose prose-sm"></div>
                </div>
            </div>
        </section>

        <!-- 4. Apology (New Feature) -->
        <section>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-2xl">ğŸš‘</span>
                <h2 class="font-bold text-slate-800 text-lg">ç´§æ€¥æ•‘ç« (Apology)</h2>
            </div>
            <div class="card border-l-4 border-orange-500 bg-gradient-to-br from-white to-orange-50/30">
                <p class="text-xs text-slate-500 mb-3 ml-1">åšé”™äº‹æƒ¹å¥¹ç”Ÿæ°”äº†ï¼Ÿå¿«é€Ÿæ­¢æŸã€‚</p>
                <select id="apologyType" class="w-full p-3 border border-slate-200 rounded-xl mb-3 text-sm bg-white outline-none focus:border-orange-500">
                    <option value="forgot_task">ğŸ§  å¿˜è®°äº¤ä»£çš„äº‹ (å¥å¿˜)</option>
                    <option value="too_slow">ğŸ¢ åŠ¨ä½œå¤ªæ…¢/æ‹–å»¶</option>
                    <option value="bad_temper">ğŸ’¥ è„¾æ°”å/è¯­æ°”é‡</option>
                    <option value="ignored_msg">ğŸ”• å¿½ç•¥ä¿¡æ¯/æ²¡å›ç”µè¯</option>
                </select>
                <button onclick="runGemini('apology')" class="btn-primary bg-orange-600 shadow-orange-200">
                    âœ¨ æ±‚ç”ŸæŒ‡å— (è¯æœ¯+è¡¥å¿)
                </button>
                <div id="result-apology" class="mt-4 hidden bg-white p-4 rounded-xl border border-orange-100 text-sm shadow-sm">
                    <div id="content-apology" class="prose prose-sm"></div>
                </div>
            </div>
        </section>

        <!-- 5. Surprise & Warmth (New Features) -->
        <div class="grid grid-cols-2 gap-4">
            <!-- Surprise -->
            <section>
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-xl">ğŸ</span>
                    <h2 class="font-bold text-slate-800 text-sm">æ¯æ—¥æƒŠå–œ</h2>
                </div>
                <div class="card border-t-4 border-yellow-500 h-full flex flex-col justify-between p-3">
                    <select id="surpriseContext" class="w-full p-2 border border-slate-200 rounded-lg mb-2 text-xs bg-white outline-none">
                        <option value="at_home">ğŸ  åœ¨å®¶</option>
                        <option value="digital">ğŸ“± æ‰‹æœº/çº¿ä¸Š</option>
                        <option value="food">ğŸ© é£Ÿç‰©</option>
                    </select>
                    <button onclick="runGemini('surprise')" class="w-full bg-yellow-500 text-white font-bold py-2 rounded-lg text-xs shadow-sm">
                        ç”Ÿæˆç‚¹å­
                    </button>
                    <div id="result-surprise" class="mt-2 hidden text-xs text-slate-600 bg-slate-50 p-2 rounded border border-slate-100"><div id="content-surprise" class="prose prose-sm"></div></div>
                </div>
            </section>
            
            <!-- Warmth -->
            <section>
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-xl">ğŸ¥°</span>
                    <h2 class="font-bold text-slate-800 text-sm">æ¯æ—¥æ¸©å­˜</h2>
                </div>
                <div class="card border-t-4 border-purple-400 h-full flex flex-col justify-between p-3">
                    <p class="text-[10px] text-slate-400 mb-2">ä¿ƒè¿›éæ€§æ¥è§¦çš„äº²å¯†æ„Ÿã€‚</p>
                    <button onclick="runGemini('warmth')" class="w-full bg-purple-500 text-white font-bold py-2 rounded-lg text-xs shadow-sm mt-auto">
                        ä»Šæ—¥ä»»åŠ¡
                    </button>
                    <div id="result-warmth" class="mt-2 hidden text-xs text-slate-600 bg-slate-50 p-2 rounded border border-slate-100"><div id="content-warmth" class="prose prose-sm"></div></div>
                </div>
            </section>
        </div>

        <!-- 6. Distance & Reunion (Bottom Section) -->
        <section class="border-t border-slate-200 pt-6 mt-8">
            <div class="flex items-center gap-2 mb-4 justify-center opacity-70">
                <span class="text-xl">ğŸ“…</span>
                <h2 class="font-bold text-slate-500">å¼‚åœ° (27-30) & é‡é€¢ (31)</h2>
            </div>

            <!-- Countdown Banner -->
            <div class="bg-slate-800 rounded-xl p-4 text-white shadow-lg mb-4 flex justify-between items-center">
                <div>
                    <h2 class="text-sm font-bold text-slate-200">31å· Sunway Carnival</h2>
                    <p class="text-[10px] text-slate-400">ç›®æ ‡: è®©å¥¹å¾ˆæƒ³æˆ‘</p>
                </div>
                <div class="text-xl font-mono font-bold text-sky-400" id="countdownTimer">--å¤©</div>
            </div>

            <!-- Distance Tool -->
            <div class="card border-l-4 border-sky-500 mb-4 opacity-90 hover:opacity-100">
                <div class="flex justify-between mb-2">
                    <h3 class="font-bold text-sm text-sky-800">âœˆï¸ å¼‚åœ°ä¼ æƒ…</h3>
                </div>
                <select id="distanceContext" class="w-full p-2 border border-slate-200 rounded mb-2 text-sm bg-white">
                    <option value="son_update">ğŸ“¸ å„¿å­å¾ˆä¹– (å±•ç¤ºç¨³é‡)</option>
                    <option value="miss_you_night">ğŸŒ™ æ™šä¸Šæƒ³ä½  (æš§æ˜§)</option>
                    <option value="house_chores">ğŸ§¹ å®¶é‡Œå·²æ‰“æ‰« (å®‰å¿ƒ)</option>
                </select>
                <button onclick="runGemini('distance')" class="w-full bg-sky-600 text-white font-bold py-2 rounded text-xs shadow-sm">ç”Ÿæˆä¼ æƒ…ä¿¡æ¯</button>
                <div id="result-distance" class="mt-2 hidden text-sm text-slate-600 bg-slate-50 p-2 rounded"><div id="content-distance"></div></div>
            </div>

            <!-- Reunion Tool -->
            <div class="card border-l-4 border-indigo-500 opacity-90 hover:opacity-100">
                <div class="flex justify-between mb-2">
                    <h3 class="font-bold text-sm text-indigo-800">ğŸ¡ 31å·ç­–åˆ’</h3>
                </div>
                <select id="reunionGoal" class="w-full p-2 border border-slate-200 rounded mb-2 text-sm bg-white">
                    <option value="first_moment">ğŸ‘‹ è§é¢ç¬¬ä¸€åˆ»</option>
                    <option value="dinner_talk">ğŸ½ï¸ æ™šé¤è¯é¢˜</option>
                    <option value="movie_touch">ğŸ¬ çœ‹æˆå°åŠ¨ä½œ</option>
                </select>
                <button onclick="runGemini('reunion')" class="w-full bg-indigo-600 text-white font-bold py-2 rounded text-xs shadow-sm">ç”Ÿæˆé‡é€¢å»ºè®®</button>
                <div id="result-reunion" class="mt-2 hidden text-sm text-slate-600 bg-slate-50 p-2 rounded"><div id="content-reunion" class="prose prose-sm"></div></div>
            </div>
        </section>

    </main>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let globalApiKey = localStorage.getItem('local_gemini_key'); // Local backup
        let currentUser = null;

        // --- 1. AUTH & INIT LOGIC ---
        // Enhanced to strictly wait for auth before syncing
        
        // Listen to Auth State
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                updateStatus("online");
                // Attempt auto-login if credentials exist
                const savedSyncId = localStorage.getItem('harmony_sync_id');
                const savedSyncPin = localStorage.getItem('harmony_sync_pin');
                if (savedSyncId && savedSyncPin) {
                    attemptCloudSync(savedSyncId, savedSyncPin, true);
                } else {
                    showAuthModal();
                }
            } else {
                currentUser = null;
                updateStatus("connecting");
                // Explicitly sign in anonymously
                auth.signInAnonymously().catch((error) => {
                    console.error("Auth failed:", error);
                    updateStatus("error");
                });
            }
        });

        function showAuthModal() {
            document.getElementById('auth-modal').classList.remove('hidden');
            if (!globalApiKey) {
                document.getElementById('key-section').classList.remove('hidden');
            }
        }
        
        function closeAuthModal() {
            document.getElementById('auth-modal').classList.add('hidden');
        }

        async function handleCloudSync() {
            // Guard Rule 3: Auth check
            if (!currentUser) {
                document.getElementById('auth-msg').innerText = "æ­£åœ¨å»ºç«‹å®‰å…¨è¿æ¥ï¼Œè¯·ç¨ç­‰...";
                return;
            }

            const syncId = document.getElementById('sync-id').value.trim();
            const pin = document.getElementById('sync-pin').value.trim();
            const keyInput = document.getElementById('api-key-input').value.trim();
            const msg = document.getElementById('auth-msg');
            
            if (!syncId || !pin) return msg.innerText = "è¯·è¾“å…¥è´¦å·å’Œå¯†ç ";
            msg.innerText = "å¤„ç†ä¸­...";

            try {
                // Rule 1: Use correct public path
                const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sync_users').doc(syncId);
                const docSnap = await docRef.get();

                if (docSnap.exists) {
                    // Login
                    const data = docSnap.data();
                    if (data.pin === pin) {
                        globalApiKey = data.apiKey;
                        localStorage.setItem('local_gemini_key', globalApiKey);
                        localStorage.setItem('harmony_sync_id', syncId);
                        localStorage.setItem('harmony_sync_pin', pin);
                        msg.innerText = "åŒæ­¥æˆåŠŸï¼";
                        msg.className = "text-center text-xs text-green-500 h-4";
                        setTimeout(closeAuthModal, 1000);
                    } else {
                        msg.innerText = "å¯†ç é”™è¯¯";
                        msg.className = "text-center text-xs text-red-500 h-4";
                    }
                } else {
                    // Register
                    if (!keyInput && !globalApiKey) {
                        document.getElementById('key-section').classList.remove('hidden');
                        return msg.innerText = "æ–°è´¦å·ï¼šè¯·è¾“å…¥ API Key ä»¥ä¿å­˜";
                    }

                    const keyToSave = keyInput || globalApiKey;
                    if (!keyToSave.startsWith("AIza")) return msg.innerText = "API Key æ ¼å¼é”™è¯¯";

                    await docRef.set({
                        pin: pin,
                        apiKey: keyToSave,
                        createdAt: new Date().toISOString()
                    });
                    
                    globalApiKey = keyToSave;
                    localStorage.setItem('local_gemini_key', globalApiKey);
                    localStorage.setItem('harmony_sync_id', syncId);
                    localStorage.setItem('harmony_sync_pin', pin);
                    
                    msg.innerText = "æ³¨å†ŒæˆåŠŸï¼";
                    msg.className = "text-center text-xs text-green-500 h-4";
                    setTimeout(closeAuthModal, 1000);
                }
            } catch (e) {
                console.error(e);
                msg.innerText = "æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•";
            }
        }

        function attemptCloudSync(id, pin, silent) {
            if (!currentUser) return; // Wait for auth listener
            
            const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sync_users').doc(id);
            docRef.get().then(doc => {
                if (doc.exists && doc.data().pin === pin) {
                    globalApiKey = doc.data().apiKey;
                    localStorage.setItem('local_gemini_key', globalApiKey);
                } else if (!silent) {
                    showAuthModal();
                }
            }).catch(err => console.error("Sync check failed", err));
        }

        function updateStatus(state) {
            const ind = document.getElementById('status-indicator');
            const txt = document.getElementById('status-text');
            if (state === "online") {
                ind.className = "w-2 h-2 rounded-full bg-green-500";
                txt.innerText = "åœ¨çº¿";
            } else if (state === "connecting") {
                ind.className = "w-2 h-2 rounded-full bg-orange-400 animate-pulse";
                txt.innerText = "è¿æ¥ä¸­...";
            } else {
                ind.className = "w-2 h-2 rounded-full bg-red-500";
                txt.innerText = "ç¦»çº¿";
            }
        }

        // --- 2. GEMINI AI LOGIC ---
        async function runGemini(type) {
            if (!globalApiKey) {
                showAuthModal();
                return;
            }

            const loadingBtn = document.querySelector(`button[onclick="runGemini('${type}')"]`);
            const originalText = loadingBtn.innerHTML;
            const resultBox = document.getElementById(`result-${type}`);
            const contentBox = document.getElementById(`content-${type}`);

            loadingBtn.innerHTML = '<div class="loading-spinner"></div> AI æ€è€ƒä¸­...';
            loadingBtn.disabled = true;
            resultBox.classList.add('hidden');

            let systemPrompt = "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ä¸¤æ€§å…³ç³»ä¸å¿ƒç†å­¦ä¸“å®¶ã€‚ç”¨æˆ·æ˜¯38å²ä¸ˆå¤«ï¼Œæ·±çˆ±37å²å¦»å­ï¼ˆæ…¢çƒ­å‹ï¼‰ï¼Œæœ‰6å²å„¿å­ã€‚";
            let prompt = "";

            if (type === 'message') {
                const ctx = document.getElementById('msgContext').value;
                systemPrompt += " ä»»åŠ¡ï¼šç”Ÿæˆä¸€æ¡ç®€çŸ­æ¸©æš–çš„å¾®ä¿¡ï¼ˆ50å­—å†…ï¼‰ï¼Œå¹¶é™„å¸¦ä¸€ä¸ªå…·ä½“çš„å¾®è¡ŒåŠ¨ï¼ˆMicro-Actionï¼‰ã€‚Markdownæ ¼å¼ã€‚";
                prompt = `åœºæ™¯ï¼š${ctx}ã€‚è¾“å‡ºæ ¼å¼ï¼š\n**çŸ­ä¿¡**ï¼š...\n\n**è¡ŒåŠ¨**ï¼š...`;
            }
            else if (type === 'deeptalk') {
                const vibe = document.getElementById('topicVibe').value;
                prompt = `ç»™ä¸€ä¸ªèŠå¤©è¯é¢˜ã€‚æ°›å›´ï¼š${vibe}ã€‚æ‰“ç ´æ—¥å¸¸ã€‚`;
            }
            else if (type === 'booster') {
                const goal = document.getElementById('boosterGoal').value;
                systemPrompt += " ä»»åŠ¡ï¼šå¤§å¸ˆçº§æ€§å¿ƒç†å»ºè®®ã€‚Markdownæ ¼å¼ã€‚";
                if(goal === 'aftercare') prompt = "æ€§çˆ±åé©¬ä¸Šåšå“ª3ä»¶å°äº‹ï¼ˆè¨€è¯­/åŠ¨ä½œï¼‰ï¼Œå»ºç«‹Afterglowï¼Ÿ";
                if(goal === 'during_sex_talk') prompt = "æ€§çˆ±ä¸­èŠä»€ä¹ˆèƒ½æ‹‰è¿‘çµé­‚è·ç¦»ï¼Ÿç»™3ä¸ªè¯æœ¯ã€‚";
                if(goal === 'passive_to_active') prompt = "å¦‚ä½•è®©å¥¹ä»è¢«åŠ¨å˜ä¸»åŠ¨ï¼ŸåŸç†+3ä¸ªå»ºè®®ã€‚";
            }
            else if (type === 'apology') {
                const r = document.getElementById('apologyType').value;
                systemPrompt += " ä»»åŠ¡ï¼šåšé”™äº‹é“æ­‰ä¸è¡¥æ•‘ã€‚ä¸æ‰¾å€Ÿå£ï¼ŒçœŸè¯šã€‚";
                if(r === 'forgot_task') prompt = "æˆ‘å¿˜è®°äº†å¥¹äº¤ä»£çš„äº‹ã€‚æ±‚ç”ŸæŒ‡å—ï¼š1.é“æ­‰è¯æœ¯ 2.è¡¥æ•‘åŠ¨ä½œ";
                if(r === 'too_slow') prompt = "æˆ‘åŠ¨ä½œå¤ªæ…¢è®©å¥¹çƒ¦ã€‚æ±‚ç”ŸæŒ‡å—ï¼š1.å®‰æŠšè¯æœ¯ 2.æ•ˆç‡å±•ç¤º";
                if(r === 'bad_temper') prompt = "æˆ‘åˆšæ‰è„¾æ°”ä¸å¥½ã€‚æ±‚ç”ŸæŒ‡å—ï¼š1.ç ´å†°è¯æœ¯ 2.æ¶ˆæ°”ä¸¾åŠ¨";
                if(r === 'ignored_msg') prompt = "å¿™å·¥ä½œå¿½ç•¥äº†å¥¹ä¿¡æ¯ã€‚æ±‚ç”ŸæŒ‡å—ï¼š1.è§£é‡Š 2.è¡¥å¿";
            }
            else if (type === 'surprise') {
                const c = document.getElementById('surpriseContext').value;
                prompt = `åœºæ™¯ï¼š${c}ã€‚ç»™ä¸€ä¸ªä½æˆæœ¬é«˜æƒ…ç»ªä»·å€¼çš„æƒŠå–œç‚¹å­ã€‚`;
            }
            else if (type === 'warmth') {
                prompt = "ç»™ä¸€ä¸ªä»Šå¤©å¯ä»¥åšçš„éæ€§æ¥è§¦çš„æ¸©é¦¨å°äº’åŠ¨/ä»»åŠ¡ã€‚";
            }
            else if (type === 'distance') {
                const c = document.getElementById('distanceContext').value;
                prompt = `åœºæ™¯ï¼š${c}ã€‚ä¸ˆå¤«å¸¦å¨ƒï¼Œå¦»åœ¨å¤–åœ°ã€‚å†™å¾®ä¿¡å±•ç¤ºé è°±å’Œæ€å¿µã€‚`;
            }
            else if (type === 'reunion') {
                const g = document.getElementById('reunionGoal').value;
                prompt = `31å·Sunway Carnivalæ¥å¦»ã€‚ç›®æ ‡ï¼š${g}ã€‚ç»™å»ºè®®ã€‚`;
            }

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${globalApiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } })
                });
                const data = await response.json();
                const mdText = data.candidates?.[0]?.content?.parts?.[0]?.text || "AI æš‚æ—¶æ²‰é»˜";

                if (type === 'deeptalk') contentBox.innerText = mdText;
                else contentBox.innerHTML = marked.parse(mdText);

                resultBox.classList.remove('hidden');
            } catch (e) {
                alert("ç½‘ç»œæˆ–Keyé”™è¯¯ï¼Œè¯·æ£€æŸ¥äº‘ç«¯åŒæ­¥");
            } finally {
                loadingBtn.innerHTML = originalText;
                loadingBtn.disabled = false;
            }
        }

        // Countdown
        function updateCount() {
            const t = new Date("2025-12-31T18:00:00").getTime();
            const n = new Date().getTime();
            const d = t - n;
            document.getElementById("countdownTimer").innerText = (d < 0 ? 0 : Math.floor(d / (1000 * 60 * 60 * 24)) + 1) + "å¤©";
        }
        updateCount();
    </script>
</body>
</html>