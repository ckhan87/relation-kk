<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harmony V25 (Force Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* åŸºç¡€è®¾ç½® */
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #F8FAFC; color: #334155; -webkit-tap-highlight-color: transparent; }
        
        /* å¡ç‰‡è®¾è®¡ */
        .section-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; padding-left: 0.25rem; }
        .section-title { font-weight: 900; font-size: 1.125rem; color: #1e293b; }
        
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); padding: 1.25rem; border: 1px solid #e2e8f0; transition: transform 0.1s; position: relative; overflow: hidden; margin-bottom: 1rem; }
        .card:active { transform: scale(0.995); }
        .card::before { content: ''; position: absolute; top: 0; left: 0; width: 6px; height: 100%; }
        
        /* é¢œè‰²åˆ†ç±» */
        .card-health::before { background-color: #10b981; }
        .card-love::before { background-color: #ec4899; }
        .card-bridge::before { background-color: #8b5cf6; }
        .card-spark::before { background-color: #f59e0b; }
        .card-sex::before { background-color: #f43f5e; }
        .card-life::before { background-color: #06b6d4; }
        
        /* æŒ‰é’® */
        .btn { font-weight: 700; padding: 0.875rem; border-radius: 0.75rem; width: 100%; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 0.5rem; font-size: 0.95rem; }
        .btn-health { background-color: #ecfdf5; color: #047857; border: 1px solid #a7f3d0; }
        .btn-love { background-color: #fdf2f8; color: #be185d; border: 1px solid #fbcfe8; }
        .btn-bridge { background-color: #f5f3ff; color: #7c3aed; border: 1px solid #ddd6fe; } 
        .btn-spark { background-color: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
        .btn-sex { background-color: #fff1f2; color: #e11d48; border: 1px solid #fda4af; }
        .btn-life { background-color: #ecfeff; color: #0e7490; border: 1px solid #a5f3fc; }
        
        /* é¢„è§ˆåŒº */
        .preview-box { margin-top: 1rem; padding: 1rem; border-radius: 0.75rem; background: #f8fafc; border: 1px dashed #cbd5e1; cursor: pointer; position: relative; }
        .click-hint { position: absolute; top: -10px; right: 10px; background: #334155; color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 99px; font-weight: bold; }
        
        /* çŠ¶æ€å¾½ç«  */
        .offline-badge { position: absolute; bottom: -8px; right: 10px; background: #94a3b8; color: white; font-size: 0.6rem; padding: 1px 6px; border-radius: 4px; font-weight: bold; opacity: 0.8; }
        .online-badge { position: absolute; bottom: -8px; right: 10px; background: #10b981; color: white; font-size: 0.6rem; padding: 1px 6px; border-radius: 4px; font-weight: bold; opacity: 0.8; }

        /* é»„è‰²é«˜äº® */
        mark { background-color: #fef9c3; color: #854d0e; padding: 2px 6px; border-radius: 4px; font-weight: 600; border: 1px dashed #fde047; }

        /* é˜…è¯»å™¨ */
        #reader-modal { position: fixed; inset: 0; z-index: 100; background: white; transform: translateY(100%); transition: transform 0.25s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; }
        #reader-modal.open { transform: translateY(0); }
        #reader-content { flex: 1; overflow-y: auto; padding: 1.5rem; padding-bottom: 6rem; }
        .prose { font-size: 1.2rem; line-height: 1.75; color: #334155; }
        .prose h3 { font-size: 1.4rem; font-weight: 800; color: #0f172a; margin-top: 1.5em; margin-bottom: 0.5em; }
        .prose ul { padding-left: 0; list-style: none; }
        .prose li { margin-bottom: 1rem; position: relative; padding-left: 1.5rem; }
        .prose li::before { content: "â†’"; position: absolute; left: 0; color: #94a3b8; font-weight: bold; }
        .spinner { width: 18px; height: 18px; border: 3px solid currentColor; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 90; backdrop-filter: blur(4px); }
    </style>
</head>
<body class="pb-32">

    <!-- Header -->
    <header class="bg-white/90 backdrop-blur sticky top-0 z-40 border-b border-slate-200 px-5 py-4 flex justify-between items-center">
        <div>
            <h1 class="font-black text-xl text-slate-800 tracking-tight">Harmony V25</h1>
            <p class="text-xs text-slate-400 font-medium">Force Updated Key</p>
        </div>
        <button onclick="openKeyModal()" class="text-xs font-bold text-slate-500 bg-slate-100 px-3 py-2 rounded-lg">âš™ï¸ è®¾ç½®</button>
    </header>

    <main class="max-w-md mx-auto px-4 mt-6 space-y-10">

        <!-- ZONE 1: å¥åº· (SOS) -->
        <section>
            <div class="section-header">
                <span class="text-2xl">ğŸ¥</span>
                <h2 class="section-title text-emerald-700">å¥åº·æ€¥æ•‘åŒ… (Health)</h2>
            </div>
            <div class="card card-health">
                <p class="text-xs text-slate-500 mb-3 font-medium">å¥¹èº«ä½“ä¸é€‚æ—¶...</p>
                <select id="healthIssue" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none mb-3 font-medium text-slate-700">
                    <option value="period">ğŸ©¸ ç»æœŸï¼šç—›ç»/è…°é…¸</option>
                    <option value="neck_pain">ğŸ¦’ é¢ˆæ¤ï¼šé•¿æœŸé…¸ç—›</option>
                    <option value="constipation">ğŸš½ è‚ èƒƒï¼šä¾¿ç§˜å›°æ‰°</option>
                    <option value="bloating">ğŸ¡ è‚ èƒƒï¼šèƒƒèƒ€æ°”</option>
                    <option value="headache">ğŸ¤• å¤´éƒ¨ï¼šåå¤´ç—›</option>
                </select>
                <button onclick="runEngine('healthcare')" class="btn btn-health">
                    <span>ğŸš‘ è·å–æŠ¤ç†æŒ‡å—</span>
                    <div id="loading-healthcare" class="spinner hidden"></div>
                </button>
                <div id="result-healthcare" class="preview-box hidden" onclick="openReader(this)">
                    <div class="click-hint">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
                    <div id="content-healthcare" class="line-clamp-3 text-sm text-slate-600"></div>
                </div>
            </div>
        </section>

        <!-- ZONE 2: å®‰å…¨æ„Ÿ (Zero Pressure) -->
        <section>
            <div class="section-header">
                <span class="text-2xl">â˜ï¸</span>
                <h2 class="section-title text-violet-700">æ— å‹äº²å¯† (Safe Zone)</h2>
            </div>
            <div class="card card-bridge">
                <p class="text-xs text-slate-500 mb-3 font-medium">å•çº¯è¡¨è¾¾çˆ±æ„ï¼Œæ˜ç¡®ä»Šå¤©â€œä¸åšçˆ±â€ã€‚</p>
                <select id="nopressureContext" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none mb-3 font-medium text-slate-700">
                    <option value="morning_routine">â˜€ï¸ æ—©æ™¨/å‡ºé—¨å‰</option>
                    <option value="sofa_relax">ğŸ›‹ï¸ æ™šä¸Šæ²™å‘æ—¶é—´</option>
                    <option value="bedtime_cuddle">ğŸŒ™ ç¡å‰æ‹¥æŠ± (çº¯ç¡è§‰)</option>
                    <option value="helping_hand">ğŸ¤² åšå®¶åŠ¡/å¸¦å¨ƒæ—¶</option>
                    <option value="tired_support">ğŸ”‹ å¥¹å¾ˆç´¯æ—¶</option>
                </select>
                <button onclick="runEngine('nopressure')" class="btn btn-bridge">
                    <span>ğŸ›¡ï¸ è·å–"å…æ­»é‡‘ç‰Œ"åŠ¨ä½œ</span>
                    <div id="loading-nopressure" class="spinner hidden"></div>
                </button>
                <div id="result-nopressure" class="preview-box hidden" onclick="openReader(this)">
                    <div class="click-hint">ç‚¹å‡»æŸ¥çœ‹</div>
                    <div id="content-nopressure" class="line-clamp-3 text-sm text-slate-600"></div>
                </div>
            </div>
        </section>

        <!-- ZONE 2.5: å¿ƒåŠ¨å¼•ç‡ƒ (Desire Spark) -->
        <section>
            <div class="section-header">
                <span class="text-2xl">ğŸ’“</span>
                <h2 class="section-title text-amber-600">å¿ƒåŠ¨å¼•ç‡ƒ (Desire Spark)</h2>
            </div>
            <div class="card card-spark">
                <p class="text-xs text-slate-500 mb-3 font-medium">å”¤é†’æ¸´æœ›ï¼šæ— å‹åŠ›è¯æœ¯ + å¾®åŠ¨ä½œã€‚</p>
                <select id="sparkContext" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none mb-3 font-medium text-slate-700">
                    <option value="praise_charm">âœ¨ èµç¾é­…åŠ›ï¼šè®©å¥¹è§‰å¾—è‡ªå·±å¾ˆè¿·äºº</option>
                    <option value="serving_tease">ğŸ’† æœåŠ¡æ’©æ‹¨ï¼šå¹å¤´/æŒ‰æ‘©æ—¶çš„å¼ åŠ›</option>
                    <option value="eye_contact">ğŸ‘€ çœ¼ç¥ä¸æ°›å›´ï¼šæ— å£°èƒœæœ‰å£°</option>
                    <option value="gratitude_love">ğŸŒ¹ æ·±æƒ…è‚¯å®šï¼šè®©å¥¹æ„ŸåŠ¨åˆ°æƒ³å›æŠ¥</option>
                </select>
                <button onclick="runEngine('spark')" class="btn btn-spark">
                    <span>ğŸ”¥ ç‚¹ç‡ƒå¿ƒä¸­æ¸´æœ›</span>
                    <div id="loading-spark" class="spinner hidden"></div>
                </button>
                <div id="result-spark" class="preview-box hidden" onclick="openReader(this)">
                    <div class="click-hint">ç‚¹å‡»æŸ¥çœ‹</div>
                    <div id="content-spark" class="line-clamp-3 text-sm text-slate-600"></div>
                </div>
            </div>
        </section>

        <!-- ZONE 3: å…³ç³»å‡æ¸© (Connection) -->
        <section>
            <div class="section-header">
                <span class="text-2xl">ğŸ’Œ</span>
                <h2 class="section-title text-pink-700">å…³ç³»å‡æ¸© (Connection)</h2>
            </div>
            
            <!-- Message -->
            <div class="card card-love mb-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-slate-800">æš–å¿ƒä¿¡ä½¿ Pro</h3>
                    <span class="text-[10px] bg-pink-100 text-pink-600 px-2 py-0.5 rounded font-bold">3ç§é£æ ¼</span>
                </div>
                <select id="msgContext" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none mb-3">
                    <option value="post_sex_cold">ğŸ›Œ è´¤è€…æ—¶é—´ (æ‰“ç ´å†·æ·¡)</option>
                    <option value="wife_stressed_work">ğŸ¤¯ å¥¹å‹åŠ›å¤§ (æ”¯æŒ)</option>
                    <option value="wfh_lunch">ğŸ  WFH åˆé—´ (ç ´å†°)</option>
                    <option value="apology_ignore">ğŸ˜“ å¿½ç•¥äº†å¥¹ (è¡¥æ•‘)</option>
                    <option value="random_love">ğŸ’– æ—¥å¸¸æ’©æ‹¨ (éšæœº)</option>
                </select>
                <button onclick="runEngine('message')" class="btn btn-love">
                    <span>âœ¨ ç”Ÿæˆ 3 ä¸ªé€‰é¡¹</span>
                    <div id="loading-message" class="spinner hidden"></div>
                </button>
                <div id="result-message" class="preview-box hidden" onclick="openReader(this)">
                    <div class="click-hint">ç‚¹å‡»å…¨å±é€‰æ‹©</div>
                    <div id="content-message" class="line-clamp-3 text-sm text-slate-600"></div>
                </div>
            </div>

            <!-- Deep Talk -->
            <div class="card card-love">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-slate-800">æ·±åº¦è¯é¢˜åº“</h3>
                </div>
                <select id="topicVibe" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none mb-3">
                    <option value="relaxed">ğŸŒ™ ç¡å‰è½»æ¾ (Fun)</option>
                    <option value="nostalgic">ğŸ“¸ æ€€æ—§å›å¿† (Memory)</option>
                    <option value="future">ğŸš€ æœªæ¥æ¢¦æƒ³ (Dreams)</option>
                    <option value="appreciation">ğŸ™ äº’ç›¸æ„Ÿè°¢ (Gratitude)</option>
                </select>
                <button onclick="runEngine('deeptalk')" class="btn btn-love">
                    <span>ğŸ—£ï¸ æ¥ä¸ªæ–°è¯é¢˜</span>
                    <div id="loading-deeptalk" class="spinner hidden"></div>
                </button>
                <div id="result-deeptalk" class="preview-box hidden" onclick="openReader(this)">
                    <div class="click-hint">ç‚¹å‡»æŸ¥çœ‹</div>
                    <div id="content-deeptalk" class="line-clamp-3 text-sm text-slate-600"></div>
                </div>
            </div>
        </section>

        <!-- ZONE 4: æ€§çˆ±å®æˆ˜ (Intimacy) -->
        <section>
            <div class="section-header">
                <span class="text-2xl">ğŸ”¥</span>
                <h2 class="section-title text-rose-700">æ€§çˆ±å®æˆ˜ (Intimacy)</h2>
            </div>
            <div class="card card-sex">
                <p class="text-xs text-slate-500 mb-3 font-medium">åŸç† + æ­¥éª¤ + è¯æœ¯ (é™„é«˜äº®)</p>
                <select id="boosterGoal" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none mb-3">
                    <option value="sensitive_ears">ğŸ‘‚ æ•æ„Ÿå¸¦ï¼šè€³æœµ (æŠ—æ‹’ç›´æ¥æ‘¸)</option>
                    <option value="aftercare">ğŸ›Œ æ€§çˆ±åï¼šè®©å¿ƒæ›´é¥±æ»¡ (Aftercare)</option>
                    <option value="during_sex_talk">ğŸ’¬ æ€§çˆ±ä¸­ï¼šèŠä»€ä¹ˆ (Dirty Talk)</option>
                    <option value="passive_to_active">ğŸ’ƒ é•¿æœŸï¼šè®©å¥¹å˜ä¸»åŠ¨ (Seduction)</option>
                    <option value="foreplay_daily">ğŸ”¥ æ—¥å¸¸å‰æˆ (Foreplay)</option>
                </select>
                <button onclick="runEngine('booster')" class="btn btn-sex">
                    <span>ğŸŒ¶ï¸ è·å–æ–°æ”»ç•¥</span>
                    <div id="loading-booster" class="spinner hidden"></div>
                </button>
                <div id="result-booster" class="preview-box hidden" onclick="openReader(this)">
                    <div class="click-hint">ç‚¹å‡»é˜…è¯»æ”»ç•¥</div>
                    <div id="content-booster" class="line-clamp-3 text-sm text-slate-600"></div>
                </div>
            </div>
        </section>

        <!-- ZONE 5: ç”Ÿæ´» (Life) -->
        <section>
            <div class="section-header">
                <span class="text-2xl">ğŸ§©</span>
                <h2 class="section-title text-cyan-700">ç”Ÿæ´»è°ƒå‘³ (Life)</h2>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div class="card card-life flex flex-col justify-between">
                    <div>
                        <h3 class="font-bold text-sm text-slate-800 mb-2">ğŸš‘ ç´§æ€¥æ•‘ç«</h3>
                        <select id="apologyType" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-xs outline-none mb-2">
                            <option value="forgot_task">ğŸ§  å¿˜äº‹</option>
                            <option value="bad_temper">ğŸ’¥ è„¾æ°”å</option>
                            <option value="too_slow">ğŸ¢ åŠ¨ä½œæ…¢</option>
                        </select>
                    </div>
                    <button onclick="runEngine('apology')" class="btn btn-life text-xs py-2">
                        <span>æ±‚ç”ŸæŒ‡å—</span>
                        <div id="loading-apology" class="spinner hidden w-3 h-3"></div>
                    </button>
                    <div id="result-apology" class="hidden"><div id="content-apology"></div></div>
                </div>

                <div class="card card-life flex flex-col justify-between">
                    <div>
                        <h3 class="font-bold text-sm text-slate-800 mb-2">ğŸ˜„ æ¯æ—¥ä¸€ç¬‘</h3>
                        <select id="humorType" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-xs outline-none mb-2">
                            <option value="marriage_life">ğŸ‘« å¤«å¦»æ§½ç‚¹</option>
                            <option value="parenting_kid">ğŸ‘¶ å¸¦å¨ƒå´©æºƒ</option>
                            <option value="penang_style">ğŸœ Penang Style</option>
                        </select>
                    </div>
                    <button onclick="runEngine('humor')" class="btn btn-life text-xs py-2">
                        <span>æ¥ä¸ªæ®µå­</span>
                        <div id="loading-humor" class="spinner hidden w-3 h-3"></div>
                    </button>
                    <div id="result-humor" class="hidden"><div id="content-humor"></div></div>
                </div>
            </div>
        </section>

        <!-- ZONE 6: ç‰¹æ®Šä»»åŠ¡ -->
        <section class="opacity-80 hover:opacity-100 transition-opacity pt-4 border-t border-slate-200">
            <div class="section-header">
                <span class="text-xl">ğŸ“…</span>
                <h2 class="font-bold text-slate-500 text-base">é‡é€¢ & å¼‚åœ°</h2>
            </div>
            <div class="flex gap-2 overflow-x-auto pb-2">
                <div class="flex-shrink-0 w-40 bg-white p-3 rounded-xl border border-slate-200">
                    <div class="text-xs font-bold text-indigo-600 mb-1">âœˆï¸ å¼‚åœ°ä¼ æƒ…</div>
                    <select id="distanceContext" class="w-full text-xs mb-2 bg-slate-50 rounded"><option value="son_update">ğŸ“¸ å„¿å­å¾ˆä¹–</option><option value="miss_you_night">ğŸŒ™ æ™šä¸Šæƒ³ä½ </option></select>
                    <button onclick="runEngine('distance')" class="w-full bg-indigo-50 text-indigo-600 text-xs font-bold py-1 rounded">ç”Ÿæˆ</button>
                    <div id="result-distance" class="hidden"><div id="content-distance"></div></div>
                </div>
                <div class="flex-shrink-0 w-40 bg-white p-3 rounded-xl border border-slate-200">
                    <div class="text-xs font-bold text-indigo-600 mb-1">ğŸ¡ 31å·ç­–åˆ’</div>
                    <select id="reunionGoal" class="w-full text-xs mb-2 bg-slate-50 rounded"><option value="dinner_talk">ğŸ½ï¸ æ™šé¤è¯é¢˜</option><option value="movie_touch">ğŸ¬ å°åŠ¨ä½œ</option></select>
                    <button onclick="runEngine('reunion')" class="w-full bg-indigo-50 text-indigo-600 text-xs font-bold py-1 rounded">ç”Ÿæˆ</button>
                    <div id="result-reunion" class="hidden"><div id="content-reunion"></div></div>
                </div>
            </div>
        </section>

    </main>

    <!-- FULL SCREEN READER -->
    <div id="reader-modal">
        <div class="flex justify-between items-center px-6 py-4 border-b border-slate-100 bg-white sticky top-0 z-50">
            <span class="font-bold text-lg text-slate-800">é˜…è¯»æ¨¡å¼</span>
            <button onclick="closeReader()" class="bg-slate-100 text-slate-500 w-8 h-8 rounded-full font-bold">âœ•</button>
        </div>
        <div id="reader-content" class="prose"></div>
    </div>

    <!-- API KEY MODAL -->
    <div id="key-modal" class="hidden modal-bg flex items-center justify-center">
        <div class="bg-white p-6 rounded-2xl w-11/12 max-w-sm shadow-2xl">
            <h3 class="font-bold text-slate-800 text-lg mb-2">API Key è®¾ç½®</h3>
            <p class="text-xs text-slate-500 mb-3">å¼ºåˆ¶ä½¿ç”¨æ–° Keyã€‚</p>
            <input type="text" id="custom-api-key" placeholder="AIza..." class="w-full border p-2 rounded-lg mb-4 text-sm" value="AIzaSyBEfwvVoQSoelBlMyWWNRA8FIHlWaAlccc">
            <div class="flex gap-2">
                <button onclick="closeKeyModal()" class="flex-1 py-2 text-slate-500">å–æ¶ˆ</button>
                <button onclick="saveCustomKey()" class="flex-1 py-2 bg-slate-800 text-white rounded-lg font-bold">ä¿å­˜å¹¶é‡ç½®</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. LOCAL BACKUP LIBRARY (EXPANDED) ---
        const LOCAL_DB = {
            healthcare: [
                "### ğŸ©¸ ç»æœŸæš–å¿ƒæŠ¤ç† (1)\n* **è¯æœ¯**ï¼š<mark>è€å©†ï¼Œè¿™å‡ å¤©å®¶åŠ¡æ”¾ç€æˆ‘æ¥ï¼Œä½ åªè¦è´Ÿè´£å½“æˆ‘çš„æ ‘æ‡’å°±å¥½ã€‚</mark>\n* **è¡ŒåŠ¨**ï¼šå» Simpang Ampat é™„è¿‘çš„è¯æåº—ä¹°ç‚¹ **çº¢ç³–** ç…®å§œèŒ¶ã€‚æ™šä¸Šå¸®å¥¹**çƒ­æ•·å°è…¹**ï¼Œæ‰‹æ“çƒ­äº†è½»è½»æ‚ç€ï¼Œæ¯”çƒ­æ°´è¢‹æ›´æœ‰æ¸©åº¦ã€‚",
                "### ğŸ¦’ é¢ˆæ¤é…¸ç—›ç¼“è§£ (1)\n* **è¯æœ¯**ï¼š<mark>æ˜¯ä¸æ˜¯è„–å­åˆåƒµäº†ï¼Ÿè¿‡æ¥ï¼Œæˆ‘çš„ä¸“å±æŠ€å¸ˆæœåŠ¡ä¸Šçº¿äº†ã€‚</mark>\n* **è¡ŒåŠ¨**ï¼šè®©å¥¹ååœ¨æ²™å‘å‰ï¼Œä½ ç«™åœ¨åé¢ã€‚ç”¨å¤§æ‹‡æŒ‡æŒ‰æ‰å¥¹çš„**é£æ± ç©´**ï¼ˆåè„‘å‹ºå‘é™…çº¿å‡¹é™·å¤„ï¼‰ã€‚åŠ›åº¦è¦è½»æŸ”æ¸—é€ï¼Œä¸è¦æ­»åŠ²æŒ‰ã€‚",
                "### ğŸš½ ä¾¿ç§˜èˆ’ç¼“å»ºè®®\n* **è¯æœ¯**ï¼š<mark>æ˜¯ä¸æ˜¯è‚šå­ä¸èˆ’æœï¼Ÿä»Šæ™šæˆ‘ä»¬åƒæ¸…æ·¡ç‚¹ï¼Œæˆ‘é™ªä½ ã€‚</mark>\n* **é¥®é£Ÿ**ï¼šå»ä¹°ç‚¹ **æœ¨ç“œ (Papaya)** æˆ– **ç«é¾™æœ**ï¼Œåˆ‡å¥½äº†ç«¯ç»™å¥¹ã€‚è¿™åœ¨Penangå¾ˆå®¹æ˜“ä¹°åˆ°ï¼Œé€šä¾¿æ•ˆæœä¸€æµã€‚",
                "### ğŸ¤• åå¤´ç—›æŠ¤ç†\n* **è¯æœ¯**ï¼š<mark>è€å©†ï¼Œå…ˆæŠŠçœ¼ç›é—­ä¸Šï¼Œæˆ‘åœ¨å‘¢ã€‚</mark>\n* **è¡ŒåŠ¨**ï¼šå…³æ‰æˆ¿é—´çš„å¤§ç¯ï¼Œåªç•™å°å¤œç¯ã€‚ç”¨æŒ‡è…¹è½»è½»æ¢³å¥¹çš„å¤´çš®ï¼Œä»å‰é¢å‘é™…çº¿å¾€åæ¢³ï¼Œè¿™æ˜¯æœ€è§£å‹çš„åŠ¨ä½œã€‚"
            ],
            nopressure: [
                "### â˜€ï¸ æ—©æ™¨æ— å‹å¾®ç”œ\n* **åŠ¨ä½œ**ï¼šå‡ºé—¨å‰æŠ±å¥¹ä¸€ä¸‹ï¼Œæ¯”å¹³æ—¶å¤šåœç•™ 3 ç§’ï¼Œæ·±å‘¼å¸é—»ä¸€ä¸‹å¥¹çš„å¤´å‘ã€‚\n* **è¯æœ¯**ï¼š<mark>åªæ˜¯æƒ³å……ä¸ªç”µå†å‡ºé—¨ã€‚ä»Šæ™šè§ã€‚</mark>",
                "### ğŸ›‹ï¸ æ²™å‘ä¸Šçš„ä¾å\n* **åŠ¨ä½œ**ï¼šçœ‹ç”µè§†æ—¶ï¼ŒæŠŠè…¿ç»™å¥¹å½“æ•å¤´ï¼Œæˆ–è€…åªæ˜¯æ¡ç€å¥¹çš„æ‰‹ç©æ‰‹æŒ‡ã€‚\n* **è¯æœ¯**ï¼š<mark>å°±æƒ³è¿™æ ·é™é™è·Ÿä½ å¾…ç€ï¼Œä¸è¯´è¯ä¹Ÿå¾ˆå¥½ã€‚</mark>",
                "### ğŸ¤² å®¶åŠ¡æ—¶çš„é»˜å¥‘\n* **åŠ¨ä½œ**ï¼šç»è¿‡å¨æˆ¿æ—¶ï¼Œè½»è½»æ‹ä¸€ä¸‹å¥¹çš„èƒŒï¼ˆä¸æ˜¯å±è‚¡ï¼ï¼‰ï¼Œæˆ–è€…å¸®å¥¹æŠŠæ‰ä¸‹æ¥çš„å¤´å‘åˆ«åˆ°è€³åã€‚\n* **è¯æœ¯**ï¼š<mark>è€å©†è¾›è‹¦äº†ï¼Œè¿™é‡Œäº¤ç»™æˆ‘å°±å¥½ã€‚</mark>"
            ],
            spark: [
                "### âœ¨ èµç¾å¥¹çš„é­…åŠ›\n* **åŠ¨ä½œ**ï¼šå½“å¥¹åˆšæ´—å®Œæ¾¡æˆ–è€…æ¢å¥½è¡£æœæ—¶ï¼Œå®šå®šåœ°çœ‹å¥¹ 5 ç§’é’Ÿã€‚\n* **è¯æœ¯**ï¼š<mark>æœ‰æ—¶å€™çœ‹ç€ä½ ï¼Œè¿˜æ˜¯ä¼šè§‰å¾—å½“åˆæˆ‘ä¹Ÿå¤ªå¹¸è¿äº†å§ã€‚</mark>\n* **åŸç†**ï¼šè®©å¥¹è§‰å¾—è‡ªå·±ä¸ä»…æ˜¯å¦ˆå¦ˆ/å¦»å­ï¼Œè¿˜æ˜¯ä¸€ä¸ªæœ‰é­…åŠ›çš„å¥³äººã€‚",
                "### ğŸ’† æœåŠ¡å¼æ’©æ‹¨\n* **åŠ¨ä½œ**ï¼šå¸®å¥¹å¹å¤´å‘ã€‚æ‰‹æŒ‡ç©¿è¿‡å‘ä¸è§¦ç¢°å¤´çš®ï¼Œå¶å°”æŒ‡å°–åˆ’è¿‡å¥¹çš„åé¢ˆã€‚\n* **è¯æœ¯**ï¼š<mark>é—­ä¸Šçœ¼äº«å—ä¸€ä¸‹ï¼Œä»Šæ™šæˆ‘æ˜¯ä½ çš„ä¸“å±å‘å‹å¸ˆã€‚</mark>"
            ],
            message: [
                "**é€‰é¡¹ 1 (æ¸©æŸ”)**ï¼š<mark>åˆšå¿™å®Œä¸€é˜µï¼Œçªç„¶æœ‰ç‚¹æƒ³ä½ ã€‚ä»Šæ™šæƒ³åƒä»€ä¹ˆï¼Ÿæˆ‘å›å»ä¹°ã€‚</mark> (è¡ŒåŠ¨ï¼šå¸¦å¥¹çˆ±åƒçš„ç”œç‚¹)",
                "**é€‰é¡¹ 2 (è°ƒçš®)**ï¼š<mark>æŠ¥å‘Šè€å©†ï¼Œä½ çš„è€å…¬ç”µé‡ä¸è¶³ï¼Œæ€¥éœ€å›å®¶æŠ±æŠ±å……ç”µã€‚</mark> (è¡ŒåŠ¨ï¼šå›å®¶ç»™ä¸ªå¤§æ‹¥æŠ±)",
                "**é€‰é¡¹ 3 (æ·±æƒ…)**ï¼š<mark>è™½ç„¶ç»“å©š7å¹´äº†ï¼Œä½†ä»Šå¤©çœ‹ä½ ç…§ç‰‡ï¼Œè¿˜æ˜¯è§‰å¾—å¿ƒåŠ¨ã€‚</mark> (è¡ŒåŠ¨ï¼šå‘ä¸€å¼ å¥¹çš„ç¾ç…§ç»™å¥¹)"
            ],
            booster: [
                "### ğŸ‘‚ è€³æœµæ•æ„Ÿå¸¦å¼€å‘\n* **åŸç†**ï¼šå¥¹èº²æ˜¯å› ä¸ºå¤ªç—’æˆ–ç”µæµæ„Ÿå¤ªå¼ºï¼ˆè¿‡æ•ï¼‰ã€‚ä¸è¦ç›´æ¥ç”¨æ‰‹ç¢°ï¼\n* **è¾¹ç¼˜è¯•æ¢**ï¼šç”¨**å‘¼å¸**ã€‚å‡‘è¿‘å¥¹è€³æœµï¼Œä½†ä¸ç¢°åˆ°ï¼Œåªæ˜¯è½»è½»å¹æ°”è¯´è¯ã€‚æˆ–è€…ç”¨**é¼»å°–**è¹­å¥¹çš„è€³åæ ¹ã€‚\n* **è¯æœ¯**ï¼š<mark>åˆ«åŠ¨ï¼Œæˆ‘ä¿è¯ä¸ç¢°å®ƒï¼Œåªè¯´æ‚„æ‚„è¯...</mark>",
                "### ğŸ›Œ æ€§çˆ±å Afterglow\n* **ç¬¬ä¸€å¥è¯**ï¼š<mark>æŠ±ç´§æˆ‘ï¼Œåˆ«æ€¥ç€èµ·æ¥ã€‚</mark>\n* **åŠ¨ä½œ**ï¼šæ‹¿çº¸å·¾å¸®å¥¹æ“¦æ‹­ï¼Œå€’ä¸€æ¯æ¸©æ°´å–‚å¥¹å–ã€‚\n* **èµç¾**ï¼š<mark>ä½ åˆšæ‰çš„å£°éŸ³çœŸå¥½å¬ / ä½ çš„çš®è‚¤å¥½æ»‘ã€‚</mark>",
                "### ğŸ’ƒ è®©å¥¹å˜ä¸»åŠ¨\n* **åŸç†**ï¼š'çŒ«ç»³ç†è®º'ã€‚ä½ è¿½å¾—å¤ªç´§ï¼Œå¥¹å°±è·‘ã€‚ä½ ç¨å¾®åæ’¤ï¼Œä¸“æ³¨äºè‡ªå·±çš„é­…åŠ›ï¼ˆå¥èº«/çœ‹ä¹¦ï¼‰ï¼Œå¥¹æ‰ä¼šå¥½å¥‡å‡‘è¿‡æ¥ã€‚\n* **è¯æœ¯**ï¼š<mark>ä»Šæ™šä½ çœ‹èµ·æ¥å¥½å±é™©ï¼Œæˆ‘å¾—ç¦»ä½ è¿œç‚¹ï¼Œæ€•æ§åˆ¶ä¸ä½ã€‚</mark>"
            ],
            apology: [
                "### ğŸ§  å¿˜è®°äº¤ä»£çš„æ€¥æ•‘\n* **è¯æœ¯**ï¼š<mark>è€å©†å¯¹ä¸èµ·ï¼Œæ˜¯æˆ‘è„‘å­çŸ­è·¯äº†ã€‚ä½ æ˜¯å¯¹çš„ï¼Œæˆ‘é©¬ä¸Šè¡¥æ•‘ï¼Œåˆ«æ°”åèº«ä½“ã€‚</mark>",
                "### ğŸ’¥ è„¾æ°”åçš„è¡¥æ•‘\n* **è¯æœ¯**ï¼š<mark>åˆšæ‰æ˜¯æˆ‘æ€åº¦ä¸å¥½ï¼Œè¯­æ°”é‡äº†ï¼Œå¯¹ä¸èµ·ã€‚æˆ‘ä¸è¯¥æŠŠæƒ…ç»ªå¸¦ç»™ä½ ã€‚</mark>"
            ],
            humor: [
                "**å¤«å¦»ç¬‘è¯**ï¼š\nè€å©†é—®è€å…¬ï¼šâ€œå¦‚æœæˆ‘æ‰è¿›æ°´é‡Œï¼Œä½ ä¼šæ•‘æˆ‘å—ï¼Ÿâ€\nè€å…¬è¯´ï¼šâ€œåºŸè¯ï¼Œæˆ‘é‚£å‡ åå¹´çš„ç§æˆ¿é’±éƒ½è—åœ¨ä½ æ‰‹æœºå£³é‡Œï¼â€",
                "**Penangç¬‘è¯**ï¼š\nPenangäººå¼€è½¦æœ€æ€•ä»€ä¹ˆï¼Ÿ\næœ€æ€•å‰é¢é‚£è¾†è½¦æ˜¯'P'ç‰Œï¼Œç„¶åè¿˜è¦è¿‡æ§Ÿå¨å¤§æ¡¥ï¼Œé‚£ä¸ªå¿ƒæƒ…æ¯”è¿™é‡Œå µè½¦è¿˜å¡ï¼"
            ],
            deeptalk: [
                "**è¯é¢˜**ï¼š<mark>å¦‚æœæˆ‘ä»¬å¯ä»¥å›åˆ°è¿‡å»ï¼Œæ”¹å˜æˆ‘ä»¬å…³ç³»ä¸­çš„ä¸€ä»¶äº‹ï¼Œä½ ä¼šæƒ³æ”¹å˜ä»€ä¹ˆï¼Ÿ</mark>",
                "**è¯é¢˜**ï¼š<mark>åœ¨ä½ å¿ƒç›®ä¸­ï¼Œå®Œç¾çš„â€œä¸€å¤©â€æ˜¯æ€æ ·çš„ï¼Ÿä»æ—©åˆ°æ™šã€‚</mark>"
            ],
            distance: [
                "**çŸ­ä¿¡ 1**ï¼š<mark>å„¿å­åˆšç¡äº†ï¼Œå®¶é‡Œçªç„¶å¥½å®‰é™ã€‚ä»¥å‰è§‰å¾—åºŠä¸å¤Ÿå¤§ï¼Œç°åœ¨è§‰å¾—åºŠå¤ªå¤§äº†ã€‚æƒ³ä½ ã€‚</mark>"
            ],
            reunion: [
                "**è§é¢ç¬¬ä¸€å¥**ï¼š<mark>ç»ˆäºå›æ¥äº†ï¼Œè®©æˆ‘å¥½å¥½æŠ±ä¸€ä¸‹ã€‚ï¼ˆæŠ±è¶³10ç§’ï¼‰</mark>"
            ]
        };

        // --- KEY SYSTEM (NEW KEY HARDCODED) ---
        const NEW_HARDCODED_KEY = "AIzaSyBEfwvVoQSoelBlMyWWNRA8FIHlWaAlccc";
        
        // Cache Buster: Change this ID to force overwrite old cache
        const STORAGE_KEY_NAME = "harmony_v25_key"; 

        function initKey() {
            // Force update on load if not set or if different
            let stored = localStorage.getItem(STORAGE_KEY_NAME);
            if (stored !== NEW_HARDCODED_KEY) {
                localStorage.setItem(STORAGE_KEY_NAME, NEW_HARDCODED_KEY);
                console.log("System: Key updated to V25 version.");
            }
        }
        initKey();
        
        function openKeyModal() { 
            document.getElementById("custom-api-key").value = localStorage.getItem(STORAGE_KEY_NAME);
            document.getElementById("key-modal").classList.remove("hidden"); 
        }
        function closeKeyModal() { document.getElementById("key-modal").classList.add("hidden"); }
        function saveCustomKey() {
            const input = document.getElementById("custom-api-key").value.trim();
            if(!input.startsWith("AIza")) return alert("æ ¼å¼é”™è¯¯");
            localStorage.setItem(STORAGE_KEY_NAME, input);
            closeKeyModal();
            alert("æ–° Key å·²ç”Ÿæ•ˆï¼");
        }

        function openReader(el) {
            const contentId = el.id.replace('result-', 'content-');
            let contentHtml = document.getElementById(contentId).innerHTML;
            
            // Offline Badge
            if (el.querySelector('.offline-badge')) {
                contentHtml = `<div class="p-2 bg-slate-100 text-slate-500 text-xs mb-4 rounded">ğŸ’¡ ç½‘ç»œä¸ç¨³å®šï¼Œä¸ºæ‚¨åˆ‡æ¢è‡³æœ¬åœ°ç²¾é€‰é”¦å›Š</div>` + contentHtml;
            }
            // Online Badge
            if (el.querySelector('.online-badge')) {
                contentHtml = `<div class="p-2 bg-green-50 text-green-600 text-xs mb-4 rounded">âœ¨ AI å®æ—¶ç”Ÿæˆ (Online)</div>` + contentHtml;
            }

            if(contentHtml) {
                document.getElementById('reader-content').innerHTML = contentHtml;
                document.getElementById('reader-modal').classList.add('open');
                document.body.style.overflow = 'hidden';
            }
        }
        function closeReader() {
            document.getElementById('reader-modal').classList.remove('open');
            document.body.style.overflow = '';
        }

        // --- CORE LOGIC ---
        async function runEngine(type) {
            const btn = document.querySelector(`button[onclick="runEngine('${type}')"]`);
            const spinner = document.getElementById(`loading-${type}`);
            const resultBox = document.getElementById(`result-${type}`);
            const contentBox = document.getElementById(`content-${type}`);

            spinner.classList.remove('hidden');
            btn.disabled = true;
            btn.querySelector('span').style.opacity = '0.5';
            if(resultBox) {
                resultBox.classList.add('hidden');
                // Clean old badges
                const badges = resultBox.querySelectorAll('.offline-badge, .online-badge');
                badges.forEach(b => b.remove());
            }

            // 1. Prompt
            let systemPrompt = `ä¸¤æ€§ä¸“å®¶ã€‚ç”¨æˆ·ï¼š38å²ç”·ï¼ŒPenangã€‚å¦»37å²ã€‚æŒ‡ä»¤ï¼šæ— é“¾æ¥ï¼Œé»„è‰²é«˜äº®<mark>ï¼Œæ¯æ¬¡ä¸åŒã€‚`;
            let prompt = `éšæœºç§å­ï¼š${Math.random()}ã€‚`;

            if (type === 'healthcare') prompt += `é’ˆå¯¹${document.getElementById('healthIssue').value}æä¾›æŠ¤ç†ã€‚`;
            else if (type === 'nopressure') prompt += `æ— å‹äº²å¯†ï¼š${document.getElementById('nopressureContext').value}ã€‚å®šå¿ƒä¸¸è¯æœ¯<mark>é«˜äº®</mark>ã€‚`;
            else if (type === 'spark') prompt += `å¿ƒåŠ¨å¼•ç‡ƒï¼š${document.getElementById('sparkContext').value}ã€‚è¯æœ¯<mark>é«˜äº®</mark>ã€‚`;
            else if (type === 'message') prompt += `å¾®ä¿¡æ–‡æ¡ˆï¼š${document.getElementById('msgContext').value}ã€‚3ä¸ªé£æ ¼ã€‚`;
            else if (type === 'deeptalk') prompt += `æ·±åº¦è¯é¢˜ï¼š${document.getElementById('topicVibe').value}ã€‚`;
            else if (type === 'booster') prompt += `æ€§çˆ±æ”»ç•¥ï¼š${document.getElementById('boosterGoal').value}ã€‚`;
            else if (type === 'apology') prompt += `é“æ­‰ï¼š${document.getElementById('apologyType').value}ã€‚`;
            else if (type === 'humor') prompt += `ç¬‘è¯ï¼š${document.getElementById('humorType').value}ã€‚`;
            else if (type === 'distance') prompt += `å¼‚åœ°çŸ­ä¿¡ã€‚`;
            else if (type === 'reunion') prompt += `é‡é€¢å»ºè®®ã€‚`;

            // 2. Execute with Current Key
            const apiKey = localStorage.getItem(STORAGE_KEY_NAME) || NEW_HARDCODED_KEY;
            let success = false;
            let errorDetail = "";

            try {
                // Try 1.5-Flash First
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } })
                });
                
                if(res.status !== 200) {
                    const errData = await res.json().catch(()=>({}));
                    throw new Error(`API Error ${res.status}: ${errData.error?.message || res.statusText}`);
                }
                
                const data = await res.json();
                const mdText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if(!mdText) throw new Error("No Content Generated");

                contentBox.innerHTML = marked.parse(mdText);
                
                // Add Online Badge
                const badge = document.createElement('div');
                badge.className = 'online-badge';
                badge.innerText = 'Online';
                resultBox.appendChild(badge);
                
                success = true;

            } catch (e) {
                console.warn("API Failed:", e);
                errorDetail = e.message;
            }

            // 3. Fallback
            if (!success) {
                console.log("Using Local Backup due to:", errorDetail);
                
                // Alert user if it's a Key issue
                if(errorDetail.includes("400") || errorDetail.includes("403")) {
                    alert(`API è¿æ¥å¤±è´¥ (${errorDetail})ã€‚\n\nç³»ç»Ÿå·²ä¸ºæ‚¨åˆ‡æ¢è‡³ã€æœ¬åœ°é”¦å›Šã€‘ï¼Œç¡®ä¿æ‚¨èƒ½ç«‹å³è·å¾—å»ºè®®ã€‚è¯·ç¨åæ£€æŸ¥ Key è®¾ç½®ã€‚`);
                }

                let dbKey = type;
                if(type === 'distance' || type === 'reunion') dbKey = 'message';
                if(type === 'spark') dbKey = 'spark';
                
                const list = LOCAL_DB[dbKey] || LOCAL_DB['message'];
                const randomItem = list[Math.floor(Math.random() * list.length)];
                
                contentBox.innerHTML = marked.parse(randomItem);
                
                const badge = document.createElement('div');
                badge.className = 'offline-badge';
                badge.innerText = 'Offline Mode';
                resultBox.appendChild(badge);
            }

            // 4. Show & Auto-Open
            if(['apology', 'humor', 'distance', 'reunion', 'nopressure', 'spark'].includes(type)) {
                openReader(resultBox); 
            } else {
                resultBox.classList.remove('hidden');
            }

            spinner.classList.add('hidden');
            btn.disabled = false;
            btn.querySelector('span').style.opacity = '1';
        }
    </script>
</body>
</html>