<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harmony V14 (Reader Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* åŸºç¡€è®¾ç½® */
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #F0F4F8; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        
        /* å¡ç‰‡æ ·å¼ */
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); padding: 1.25rem; margin-bottom: 1rem; border: 1px solid #e2e8f0; transition: transform 0.1s; }
        .card:active { transform: scale(0.99); }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn-primary { color: white; font-weight: bold; padding: 0.8rem; border-radius: 0.6rem; width: 100%; transition: opacity 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; gap: 0.5rem; font-size: 0.95rem; }
        .btn-primary:active { opacity: 0.9; }
        
        /* ç»“æœé¢„è§ˆæ¡† (ç‚¹å‡»è§¦å‘å…¨å±) */
        .result-preview { 
            background: #ffffff; 
            border-radius: 0.8rem; 
            border: 2px dashed #cbd5e1; 
            padding: 1rem; 
            margin-top: 1rem; 
            cursor: pointer; 
            position: relative;
            transition: border-color 0.2s;
        }
        .result-preview:active { background-color: #f1f5f9; border-color: #94a3b8; }
        .click-hint {
            position: absolute;
            top: -10px;
            right: 10px;
            background: #3b82f6;
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: bounce 1s infinite;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

        /* --- å…¨å±é˜…è¯»å™¨æ ·å¼ (Reader Mode) --- */
        #reader-modal { 
            position: fixed; inset: 0; z-index: 200; 
            background-color: #ffffff; 
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #reader-modal.open { transform: translateY(0); }
        
        #reader-content { 
            flex: 1; overflow-y: auto; padding: 20px 24px 80px 24px; /* åº•éƒ¨ç•™ç™½ */
            -webkit-overflow-scrolling: touch; 
        }

        /* é˜…è¯»å™¨å†…çš„æ’ç‰ˆ (å¤§å­—ç‰ˆ) */
        .reader-prose { font-size: 1.25rem; line-height: 1.8; color: #1e293b; } /* 20px å­—ä½“ */
        .reader-prose h3 { color: #be185d; font-weight: 800; margin-top: 1.5em; margin-bottom: 0.8em; font-size: 1.5rem; border-left: 5px solid #be185d; padding-left: 0.5em; }
        .reader-prose strong { color: #0f172a; font-weight: 700; background-color: #fff1f2; padding: 2px 6px; border-radius: 4px; }
        .reader-prose ul { list-style-type: none; padding-left: 0; margin-bottom: 1.5em; }
        .reader-prose li { margin-bottom: 1em; position: relative; padding-left: 1.2em; }
        .reader-prose li::before { content: "â€¢"; color: #be185d; font-weight: bold; position: absolute; left: 0; font-size: 1.5em; line-height: 1; }
        .reader-prose p { margin-bottom: 1.2em; }
        .reader-prose a { color: #2563eb; text-decoration: none; border-bottom: 2px solid #93c5fd; font-weight: 600; padding-bottom: 1px; } 
        
        /* è¡¨æ ¼åœ¨å¤§å±æ¨¡å¼ä¸‹çš„ä¼˜åŒ– */
        .reader-prose table { width: 100%; border-collapse: collapse; margin-bottom: 1.5em; font-size: 1rem; display: block; overflow-x: auto; white-space: nowrap; }
        .reader-prose th, .reader-prose td { border: 1px solid #cbd5e1; padding: 12px; text-align: left; }
        .reader-prose th { background-color: #f8fafc; font-weight: bold; color: #475569; }

        /* Loading */
        .loading-spinner { border: 3px solid #ffffff; border-top: 3px solid rgba(255,255,255,0.3); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Key Modal */
        #key-modal { backdrop-filter: blur(5px); background-color: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="pb-32">

    <!-- Header -->
    <header class="bg-white/95 backdrop-blur-xl sticky top-0 z-40 border-b border-slate-200 px-5 py-3 shadow-sm flex justify-between items-center">
        <div class="flex flex-col">
            <div class="flex items-center gap-2">
                <h1 class="font-extrabold text-slate-800 text-lg tracking-tight">Harmony V14</h1>
                <span class="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full font-bold">Reader Mode</span>
            </div>
            <span class="text-[10px] text-slate-400 mt-0.5">Simpang Ampat</span>
        </div>
        <button onclick="openKeyModal()" class="text-xs bg-slate-100 text-slate-600 border border-slate-200 px-3 py-1.5 rounded-full font-medium active:bg-slate-200">
            ğŸ”‘ è®¾ç½®
        </button>
    </header>

    <!-- FULL SCREEN READER MODAL -->
    <div id="reader-modal">
        <!-- Reader Header -->
        <div class="flex justify-between items-center px-5 py-4 border-b border-slate-100 bg-white sticky top-0 z-50 shadow-sm">
            <div class="flex items-center gap-2">
                <span class="text-xl">ğŸ“–</span>
                <span class="font-bold text-slate-700">é˜…è¯»æ¨¡å¼</span>
            </div>
            <button onclick="closeReader()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-full w-8 h-8 flex items-center justify-center font-bold transition">
                âœ•
            </button>
        </div>
        <!-- Reader Content Area -->
        <div id="reader-content" class="reader-prose">
            <!-- Content will be injected here -->
        </div>
        <!-- Floating Close Button (Bottom) -->
        <div class="absolute bottom-8 left-0 right-0 flex justify-center pointer-events-none">
            <button onclick="closeReader()" class="pointer-events-auto bg-slate-800 text-white px-6 py-3 rounded-full font-bold shadow-2xl opacity-90 active:scale-95 transition">
                å…³é—­é˜…è¯»
            </button>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="key-modal" class="fixed inset-0 z-[100] flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-2xl w-11/12 max-w-sm shadow-2xl">
            <h3 class="text-lg font-bold text-slate-800 mb-2">API è®¾ç½®</h3>
            <input type="text" id="custom-api-key" placeholder="AIza..." class="w-full border border-slate-300 rounded-xl mb-3 p-2 text-sm">
            <div class="flex gap-3">
                <button onclick="closeKeyModal()" class="flex-1 py-2 text-slate-500 text-sm">å–æ¶ˆ</button>
                <button onclick="saveCustomKey()" class="flex-1 py-2 bg-slate-800 text-white rounded-xl text-sm font-bold">ä¿å­˜</button>
            </div>
            <button onclick="clearCustomKey()" class="w-full mt-3 text-xs text-red-400">æ¢å¤é»˜è®¤</button>
        </div>
    </div>

    <main class="max-w-md mx-auto px-4 mt-6 space-y-8">

        <!-- 1. Health Care -->
        <section>
            <div class="flex items-center gap-2 mb-2 px-1">
                <span class="text-2xl">ğŸ¥</span>
                <h2 class="font-bold text-slate-800 text-lg">å¥åº·å®ˆæŠ¤</h2>
            </div>
            <div class="card border-l-4 border-emerald-500">
                <p class="text-xs text-slate-500 mb-3">ç‚¹å‡»ç”Ÿæˆç»“æœå¯å…¨å±é˜…è¯»</p>
                <select id="healthIssue" class="w-full border border-slate-200 rounded-xl mb-3 p-2 bg-slate-50 outline-none focus:border-emerald-500 text-sm">
                    <option value="period">ğŸ©¸ æ¥æœˆäº‹ (ç»ç—›/ç–²åŠ³)</option>
                    <option value="neck_pain">ğŸ¦’ é•¿æœŸé¢ˆé¡¹é…¸ç—›</option>
                    <option value="constipation">ğŸš½ ä¾¿ç§˜é—®é¢˜</option>
                    <option value="bloating">ğŸ¡ èƒƒèƒ€æ°”</option>
                    <option value="headache">ğŸ¤• å¤´ç—›</option>
                </select>
                <button onclick="runGemini('healthcare')" class="btn-primary bg-emerald-600 shadow-emerald-200">
                    <span>âœ¨ è·å–å‘µæŠ¤åŠ¨ä½œ</span>
                    <div id="loading-healthcare" class="loading-spinner hidden"></div>
                </button>
                <!-- Clickable Result Preview -->
                <div id="result-healthcare" class="result-preview hidden" onclick="openReader(this)">
                    <div class="click-hint">ç‚¹å‡»å…¨å±é˜…è¯» ğŸ”</div>
                    <div id="content-healthcare" class="prose prose-sm line-clamp-3 overflow-hidden" style="max-height: 100px;"></div>
                </div>
            </div>
        </section>

        <!-- 2. Humor -->
        <section>
            <div class="flex items-center gap-2 mb-2 px-1">
                <span class="text-2xl">ğŸ˜„</span>
                <h2 class="font-bold text-slate-800 text-lg">æ¯æ—¥ä¸€ç¬‘</h2>
            </div>
            <div class="card border-l-4 border-cyan-500">
                <select id="humorType" class="w-full border border-slate-200 rounded-xl mb-3 p-2 bg-slate-50 outline-none focus:border-cyan-500 text-sm">
                    <option value="marriage_life">ğŸ‘« å¤«å¦»ç”Ÿæ´»åæ§½</option>
                    <option value="parenting_kid">ğŸ‘¶ å¸¦6å²å„¿å­çš„å´©æºƒç¬é—´</option>
                    <option value="penang_style">ğŸœ Penang Lang ä¸“å±ç¬‘è¯</option>
                    <option value="relaxing">ğŸŒ¿ çº¯æ”¾æ¾/å†·ç¬‘è¯</option>
                </select>
                <button onclick="runGemini('humor')" class="btn-primary bg-cyan-600 shadow-cyan-200">
                    <span>âœ¨ æ¥ä¸€ä¸ªæ®µå­</span>
                    <div id="loading-humor" class="loading-spinner hidden"></div>
                </button>
                <div id="result-humor" class="result-preview hidden" onclick="openReader(this)">
                    <div class="click-hint">ç‚¹å‡»å…¨å±é˜…è¯» ğŸ”</div>
                    <div id="content-humor" class="prose prose-sm line-clamp-3" style="max-height: 100px;"></div>
                </div>
            </div>
        </section>

        <!-- 3. Message -->
        <section>
            <div class="flex items-center gap-2 mb-2 px-1">
                <span class="text-2xl">ğŸ’Œ</span>
                <h2 class="font-bold text-slate-800 text-lg">æš–å¿ƒä¿¡ä½¿</h2>
            </div>
            <div class="card border-l-4 border-pink-500">
                <select id="msgContext" class="w-full border border-slate-200 rounded-xl mb-3 p-2 bg-slate-50 outline-none focus:border-pink-500 text-sm">
                    <option value="post_sex_cold">ğŸ›Œ è´¤è€…æ—¶é—´ï¼šæ‰“ç ´å†·æ·¡</option>
                    <option value="wife_stressed_work">ğŸ¤¯ å¥¹å·¥ä½œå‹åŠ›å¤§ï¼šç»™äºˆæ”¯æŒ</option>
                    <option value="wfh_lunch">ğŸ  WFH åˆé—´ï¼šæ‰“ç ´å®¤å‹æ„Ÿ</option>
                    <option value="apology_ignore">ğŸ˜“ å¿™ç¢Œå¿½ç•¥äº†å¥¹ï¼šè¡¥æ•‘</option>
                    <option value="health_care">ğŸ’Š èº«ä½“ä¸èˆ’æœï¼šæ¸©æŸ”å…³æ€€</option>
                    <option value="random_love">ğŸ’– æ²¡ä»€ä¹ˆåŸå› ï¼šæ—¥å¸¸æ’©æ‹¨</option>
                </select>
                <button onclick="runGemini('message')" class="btn-primary bg-pink-600 shadow-pink-200">
                    <span>âœ¨ ç”Ÿæˆè¯æœ¯ + è¡ŒåŠ¨</span>
                    <div id="loading-message" class="loading-spinner hidden"></div>
                </button>
                <div id="result-message" class="result-preview hidden" onclick="openReader(this)">
                    <div class="click-hint">ç‚¹å‡»å…¨å±é˜…è¯» ğŸ”</div>
                    <div id="content-message" class="prose prose-sm line-clamp-3" style="max-height: 100px;"></div>
                </div>
            </div>
        </section>

        <!-- 4. Deep Talk -->
        <section>
            <div class="flex items-center gap-2 mb-2 px-1">
                <span class="text-2xl">ğŸ—£ï¸</span>
                <h2 class="font-bold text-slate-800 text-lg">æ·±åº¦è¯é¢˜</h2>
            </div>
            <div class="card border-l-4 border-teal-500">
                <select id="topicVibe" class="w-full border border-slate-200 rounded-xl mb-3 p-2 bg-slate-50 outline-none focus:border-teal-500 text-sm">
                    <option value="relaxed">ğŸŒ™ ç¡å‰è½»æ¾ (Fun)</option>
                    <option value="nostalgic">ğŸ“¸ æ€€æ—§å›å¿† (Memory)</option>
                    <option value="future">ğŸš€ æœªæ¥æ¢¦æƒ³ (Dreams)</option>
                    <option value="appreciation">ğŸ™ äº’ç›¸æ„Ÿè°¢ (Gratitude)</option>
                </select>
                <button onclick="runGemini('deeptalk')" class="btn-primary bg-teal-600 shadow-teal-200">
                    <span>âœ¨ è·å–çµé­‚è¯é¢˜</span>
                    <div id="loading-deeptalk" class="loading-spinner hidden"></div>
                </button>
                <div id="result-deeptalk" class="result-preview hidden" onclick="openReader(this)">
                    <div class="click-hint">ç‚¹å‡»å…¨å±é˜…è¯» ğŸ”</div>
                    <p id="content-deeptalk" class="text-sm font-medium text-center text-slate-700"></p>
                </div>
            </div>
        </section>

        <!-- 5. Booster -->
        <section>
            <div class="flex items-center gap-2 mb-2 px-1">
                <span class="text-2xl">ğŸ”¥</span>
                <h2 class="font-bold text-slate-800 text-lg">äº²å¯†å‡çº§</h2>
            </div>
            <div class="card border-l-4 border-rose-600">
                <select id="boosterGoal" class="w-full border border-slate-200 rounded-xl mb-3 p-2 bg-slate-50 outline-none focus:border-rose-500 text-sm">
                    <option value="aftercare">ğŸ›Œ æ€§çˆ±åï¼šè®©å¿ƒæ›´é¥±æ»¡</option>
                    <option value="during_sex_talk">ğŸ’¬ æ€§çˆ±ä¸­ï¼šèŠä»€ä¹ˆæ‹‰è¿‘è·ç¦»ï¼Ÿ</option>
                    <option value="passive_to_active">ğŸ’ƒ é•¿æœŸï¼šå¦‚ä½•è®©å¥¹å˜ä¸»åŠ¨ï¼Ÿ</option>
                </select>
                <button onclick="runGemini('booster')" class="btn-primary bg-rose-600 shadow-rose-200">
                    <span>âœ¨ è·å–å¤§å¸ˆå»ºè®®</span>
                    <div id="loading-booster" class="loading-spinner hidden"></div>
                </button>
                <div id="result-booster" class="result-preview hidden" onclick="openReader(this)">
                    <div class="click-hint">ç‚¹å‡»å…¨å±é˜…è¯» ğŸ”</div>
                    <div id="content-booster" class="prose prose-sm line-clamp-3" style="max-height: 100px;"></div>
                </div>
            </div>
        </section>

        <!-- 6. Apology -->
        <section>
            <div class="flex items-center gap-2 mb-2 px-1">
                <span class="text-2xl">ğŸš‘</span>
                <h2 class="font-bold text-slate-800 text-lg">ç´§æ€¥æ•‘ç«</h2>
            </div>
            <div class="card border-l-4 border-orange-500">
                <select id="apologyType" class="w-full border border-slate-200 rounded-xl mb-3 p-2 bg-slate-50 outline-none focus:border-orange-500 text-sm">
                    <option value="forgot_task">ğŸ§  å¿˜è®°äº¤ä»£çš„äº‹</option>
                    <option value="too_slow">ğŸ¢ åŠ¨ä½œå¤ªæ…¢/æ‹–å»¶</option>
                    <option value="bad_temper">ğŸ’¥ è„¾æ°”å/è¯­æ°”é‡</option>
                    <option value="ignored_msg">ğŸ”• å¿½ç•¥ä¿¡æ¯/æ²¡å›ç”µè¯</option>
                </select>
                <button onclick="runGemini('apology')" class="btn-primary bg-orange-600 shadow-orange-200">
                    <span>âœ¨ æ±‚ç”ŸæŒ‡å—</span>
                    <div id="loading-apology" class="loading-spinner hidden"></div>
                </button>
                <div id="result-apology" class="result-preview hidden" onclick="openReader(this)">
                    <div class="click-hint">ç‚¹å‡»å…¨å±é˜…è¯» ğŸ”</div>
                    <div id="content-apology" class="prose prose-sm line-clamp-3" style="max-height: 100px;"></div>
                </div>
            </div>
        </section>

        <!-- 7. Weekend & Occasion -->
        <div class="grid grid-cols-1 gap-6">
             <!-- Weekend -->
            <section>
                <div class="flex items-center gap-2 mb-2 px-1">
                    <span class="text-2xl">ğŸï¸</span>
                    <h2 class="font-bold text-slate-800 text-lg">å‘¨æœ«å»å“ªå„¿</h2>
                </div>
                <div class="card border-l-4 border-lime-500">
                    <div class="flex flex-col gap-3 mb-3">
                        <select id="weekendWho" class="w-full border border-slate-200 rounded-xl p-2 bg-slate-50 text-sm">
                            <option value="family">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ å…¨å®¶ (å¸¦å¨ƒ)</option>
                            <option value="couple">ğŸ‘©â€â¤ï¸â€ğŸ‘¨ äºŒäººä¸–ç•Œ</option>
                        </select>
                        <select id="weekendLoc" class="w-full border border-slate-200 rounded-xl p-2 bg-slate-50 text-sm">
                            <option value="nearby">ğŸ¡ é™„è¿‘ä¼‘é—² (Batu Kawan)</option>
                            <option value="island">ğŸŒ‰ æ§Ÿå²›æ¸¸</option>
                            <option value="indoor">ğŸ¢ å®¤å†… (Design Village)</option>
                            <option value="outdoor">ğŸŒ³ æˆ·å¤–/æµ·è¾¹</option>
                        </select>
                    </div>
                    <button onclick="runGemini('weekend')" class="btn-primary bg-lime-600 shadow-lime-200">
                        <span>âœ¨ ç”Ÿæˆè®¡åˆ’ (å«å¯¼èˆª)</span>
                        <div id="loading-weekend" class="loading-spinner hidden"></div>
                    </button>
                    <div id="result-weekend" class="result-preview hidden" onclick="openReader(this)">
                        <div class="click-hint">ç‚¹å‡»å…¨å±é˜…è¯» ğŸ”</div>
                        <div id="content-weekend" class="prose prose-sm line-clamp-3" style="max-height: 100px;"></div>
                    </div>
                </div>
            </section>

             <!-- Occasion -->
            <section>
                <div class="flex items-center gap-2 mb-2 px-1">
                    <span class="text-2xl">ğŸŒ¹</span>
                    <h2 class="font-bold text-slate-800 text-lg">å¤§æ—¥å­ç­–åˆ’</h2>
                </div>
                <div class="card border-l-4 border-red-500">
                    <div class="flex flex-col gap-3 mb-3">
                        <select id="occasionEvent" class="w-full border border-slate-200 rounded-xl p-2 bg-slate-50 text-sm">
                            <option value="anniversary">ğŸ’ ç»“å©šçºªå¿µæ—¥</option>
                            <option value="birthday">ğŸ‚ å¥¹çš„ç”Ÿæ—¥</option>
                            <option value="valentines">ğŸ’˜ æƒ…äººèŠ‚</option>
                        </select>
                        <select id="occasionType" class="w-full border border-slate-200 rounded-xl p-2 bg-slate-50 text-sm">
                            <option value="dinner">ğŸ½ï¸ é¤å…æ¨è</option>
                            <option value="full_plan">ğŸ“… å…¨å¤©è¡Œç¨‹</option>
                            <option value="gift">ğŸ ç¤¼ç‰©å»ºè®®</option>
                        </select>
                    </div>
                    <button onclick="runGemini('occasion')" class="btn-primary bg-red-600 shadow-red-200">
                        <span>âœ¨ ç”Ÿæˆæ–¹æ¡ˆ (å«é“¾æ¥)</span>
                        <div id="loading-occasion" class="loading-spinner hidden"></div>
                    </button>
                    <div id="result-occasion" class="result-preview hidden" onclick="openReader(this)">
                        <div class="click-hint">ç‚¹å‡»å…¨å±é˜…è¯» ğŸ”</div>
                        <div id="content-occasion" class="prose prose-sm line-clamp-3" style="max-height: 100px;"></div>
                    </div>
                </div>
            </section>
        </div>

        <!-- 8. Surprise & Warmth -->
        <div class="grid grid-cols-2 gap-4">
            <!-- Surprise -->
            <section>
                <div class="flex items-center gap-2 mb-2 px-1">
                    <span class="text-xl">ğŸ</span>
                    <h2 class="font-bold text-slate-800 text-sm">æƒŠå–œ</h2>
                </div>
                <div class="card border-t-4 border-yellow-500 h-full flex flex-col justify-between p-3">
                    <select id="surpriseContext" class="w-full border border-slate-200 rounded-xl mb-2 text-xs bg-slate-50">
                        <option value="at_home">ğŸ  åœ¨å®¶</option>
                        <option value="digital">ğŸ“± çº¿ä¸Š</option>
                        <option value="food">ğŸ© é£Ÿç‰©</option>
                    </select>
                    <button onclick="runGemini('surprise')" class="btn-primary bg-yellow-500 text-xs py-2">
                        <span>ğŸ’¡ ç‚¹å­</span>
                        <div id="loading-surprise" class="loading-spinner hidden w-3 h-3"></div>
                    </button>
                    <div id="result-surprise" class="result-preview hidden p-2" onclick="openReader(this)">
                        <div class="click-hint">ğŸ”</div>
                        <div id="content-surprise" class="prose prose-sm line-clamp-3"></div>
                    </div>
                </div>
            </section>
            
            <!-- Warmth -->
            <section>
                <div class="flex items-center gap-2 mb-2 px-1">
                    <span class="text-xl">ğŸ¥°</span>
                    <h2 class="font-bold text-slate-800 text-sm">æ¸©å­˜</h2>
                </div>
                <div class="card border-t-4 border-purple-400 h-full flex flex-col justify-between p-3">
                    <p class="text-xs text-slate-400 mb-2">æš–å¿ƒå°äº’åŠ¨</p>
                    <button onclick="runGemini('warmth')" class="btn-primary bg-purple-500 text-xs py-2 mt-auto">
                        <span>ğŸ¤² ä»»åŠ¡</span>
                        <div id="loading-warmth" class="loading-spinner hidden w-3 h-3"></div>
                    </button>
                    <div id="result-warmth" class="result-preview hidden p-2" onclick="openReader(this)">
                        <div class="click-hint">ğŸ”</div>
                        <div id="content-warmth" class="prose prose-sm line-clamp-3"></div>
                    </div>
                </div>
            </section>
        </div>

        <!-- 9. Reunion (Bottom) -->
        <section class="border-t-2 border-slate-200 pt-8 mt-10">
            <div class="flex items-center gap-2 mb-4 justify-center opacity-70">
                <span class="text-xl">ğŸ“…</span>
                <h2 class="font-bold text-slate-500 text-lg">é‡é€¢å€’è®¡æ—¶ (31å·)</h2>
            </div>
            
            <div class="bg-slate-800 rounded-2xl p-5 text-white shadow-xl mb-6 flex justify-between items-center">
                <div>
                    <h2 class="text-base font-bold text-slate-200">Sunway Carnival</h2>
                    <p class="text-xs text-slate-400 mt-1">ç›®æ ‡: è®©å¥¹å¾ˆæƒ³æˆ‘</p>
                </div>
                <div class="text-2xl font-mono font-bold text-sky-400" id="countdownTimer">--å¤©</div>
            </div>

            <!-- Reunion Tools -->
            <div class="card border-l-4 border-sky-500 mb-4 opacity-95">
                 <div class="flex justify-between mb-2"><h3 class="font-bold text-sm text-sky-800">âœˆï¸ å¼‚åœ°ä¼ æƒ…</h3></div>
                 <select id="distanceContext" class="w-full border rounded-xl mb-3 bg-slate-50 p-2 text-sm"><option value="son_update">ğŸ“¸ å„¿å­å¾ˆä¹–</option><option value="miss_you_night">ğŸŒ™ æ™šä¸Šæƒ³ä½ </option></select>
                 <button onclick="runGemini('distance')" class="btn-primary bg-sky-600 text-sm py-2"><span>ğŸš€ å‘é€</span><div id="loading-distance" class="loading-spinner hidden w-3 h-3"></div></button>
                 <div id="result-distance" class="result-preview hidden" onclick="openReader(this)"><div class="click-hint">ğŸ”</div><div id="content-distance" class="prose prose-sm line-clamp-3"></div></div>
            </div>
            
            <div class="card border-l-4 border-indigo-500 opacity-95">
                 <div class="flex justify-between mb-2"><h3 class="font-bold text-sm text-indigo-800">ğŸ¡ 31å·ç­–åˆ’</h3></div>
                 <select id="reunionGoal" class="w-full border rounded-xl mb-3 bg-slate-50 p-2 text-sm"><option value="dinner_talk">ğŸ½ï¸ æ™šé¤è¯é¢˜</option><option value="movie_touch">ğŸ¬ çœ‹æˆå°åŠ¨ä½œ</option></select>
                 <button onclick="runGemini('reunion')" class="btn-primary bg-indigo-600 text-sm py-2"><span>ğŸ“… å»ºè®®</span><div id="loading-reunion" class="loading-spinner hidden w-3 h-3"></div></button>
                 <div id="result-reunion" class="result-preview hidden" onclick="openReader(this)"><div class="click-hint">ğŸ”</div><div id="content-reunion" class="prose prose-sm line-clamp-3"></div></div>
            </div>
        </section>

    </main>

    <script>
        // --- 0. HARDCODED API KEY (Permanent) ---
        const DEFAULT_KEY = "AIzaSyClDjCuLE2RpWL5v1A2DQQ0j2gnFd6p_Vg"; 
        let currentKey = localStorage.getItem("my_custom_key") || DEFAULT_KEY;

        // Modal Logic
        function openKeyModal() { document.getElementById("key-modal").classList.remove("hidden"); }
        function closeKeyModal() { document.getElementById("key-modal").classList.add("hidden"); }
        function saveCustomKey() {
            const input = document.getElementById("custom-api-key").value.trim();
            if(!input.startsWith("AIza")) return alert("Key æ ¼å¼ä¸æ­£ç¡®");
            localStorage.setItem("my_custom_key", input);
            currentKey = input;
            closeKeyModal();
            alert("Key å·²ä¿å­˜");
        }
        function clearCustomKey() {
            localStorage.removeItem("my_custom_key");
            currentKey = DEFAULT_KEY;
            closeKeyModal();
            alert("å·²æ¢å¤é»˜è®¤ Key");
        }

        // --- READER MODE LOGIC ---
        function openReader(element) {
            // Find content div inside the clicked element
            const contentDiv = element.querySelector('.prose') || element.querySelector('p');
            if (contentDiv) {
                const contentHtml = contentDiv.innerHTML;
                document.getElementById('reader-content').innerHTML = contentHtml;
                document.getElementById('reader-modal').classList.add('open');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }
        }

        function closeReader() {
            document.getElementById('reader-modal').classList.remove('open');
            document.body.style.overflow = '';
        }

        // --- 1. GEMINI LOGIC ---
        async function runGemini(type) {
            const loadingSpinner = document.getElementById(`loading-${type}`);
            const btn = loadingSpinner ? loadingSpinner.parentElement : document.querySelector(`button[onclick="runGemini('${type}')"]`);
            const resultBox = document.getElementById(`result-${type}`);
            const contentBox = document.getElementById(`content-${type}`);

            if(loadingSpinner) loadingSpinner.classList.remove('hidden');
            else btn.innerHTML = "â³";
            
            btn.disabled = true;
            resultBox.classList.add('hidden'); // Hide during loading

            // --- SYSTEM PROMPT (Context Aware + Actionable Links) ---
            let systemPrompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ä¸¤æ€§å…³ç³»ã€ä¸­åŒ»ç†ç–—å¸¸è¯†ä¸°å¯Œçš„ç”Ÿæ´»å‘å¯¼ï¼Œç†Ÿæ‚‰æ§ŸåŸ Simpang Ampat ç”Ÿæ´»ã€‚
            ç”¨æˆ·èƒŒæ™¯ï¼š38å²ä¸ˆå¤«ï¼Œå¦»37å²ï¼ˆæ…¢çƒ­ï¼‰ï¼Œ6å²å„¿å­ã€‚
            **åŸåˆ™1**ï¼šå¦»å­æœ‰é¢ˆç—›ã€ä¾¿ç§˜ã€èƒƒèƒ€ã€å¤´ç—›ã€‚å»ºè®®è¦**æ”¾æ¾ã€ç–—æ„ˆ**ã€‚
            **åŸåˆ™2**ï¼šè¾“å‡ºæ ¼å¼å¿…é¡»**æ˜“è¯»ï¼ˆå¤§æ®µè½ã€åˆ—è¡¨ï¼‰**ï¼Œä¸è¦ä½¿ç”¨å¤æ‚è¡¨æ ¼ã€‚
            **åŸåˆ™3ï¼ˆé‡è¦ï¼‰**ï¼šå½“æ¨èåœ°ç‚¹/é¤å…/æ´»åŠ¨æ—¶ï¼Œå¿…é¡»æä¾›**Google Maps æœç´¢é“¾æ¥**ï¼Œæ ¼å¼ä¸ºï¼š[ğŸ“ å¯¼èˆªåˆ°: åœ°ç‚¹å](https://www.google.com/maps/search/?api=1&query=åœ°ç‚¹å)ã€‚å¦‚æœæœ‰ç”µè¯ï¼Œä¹Ÿè¯·æä¾›ã€‚`;
            
            let prompt = "";

            if (type === 'healthcare') {
                const issue = document.getElementById('healthIssue').value;
                systemPrompt += " ä»»åŠ¡ï¼šé’ˆå¯¹ä¸é€‚æä¾›æŠ¤ç†åŠ¨ä½œã€‚";
                if(issue === 'period') prompt = "å¥¹æ¥æœˆäº‹ï¼ˆç»ç—›ï¼‰ã€‚1. æš–å¿ƒè¯ 2. ç¼“è§£è¡ŒåŠ¨ã€‚";
                if(issue === 'neck_pain') prompt = "å¥¹é¢ˆé¡¹é…¸ç—›ã€‚1. å®‰æŠš 2. ç®€æ˜“æŒ‰æ‘©/çƒ­æ•·ã€‚";
                if(issue === 'constipation') prompt = "å¥¹ä¾¿ç§˜ã€‚1. è¯æœ¯ 2. é¥®é£Ÿ(Simpang Ampatä¹°å¾—åˆ°çš„æ°´æœ)/æŒ‰æ‘©ã€‚";
                if(issue === 'bloating') prompt = "å¥¹èƒƒèƒ€ã€‚1. è¯æœ¯ 2. èˆ’ç¼“åŠ¨ä½œã€‚";
                if(issue === 'headache') prompt = "å¥¹å¤´ç—›ã€‚1. è¯æœ¯ 2. æŒ‰æ‘©ç‚¹ã€‚";
            }
            else if (type === 'weekend') {
                const who = document.getElementById('weekendWho').value;
                const loc = document.getElementById('weekendLoc').value;
                systemPrompt += " ä»»åŠ¡ï¼šSimpang Ampatå‡ºå‘å‘¨æœ«è®¡åˆ’ã€‚å¦»æœ‰é¢ˆç—›ï¼Œè¡Œç¨‹è¦è½»æ¾ã€‚**å¿…é¡»åŒ…å« Google Maps é“¾æ¥**ã€‚";
                prompt = `å‚ä¸è€…ï¼š${who}ã€‚åå¥½ï¼š${loc}ã€‚æ¨èå…·ä½“åœ°ç‚¹å’Œé¤å…ã€‚`;
            }
            else if (type === 'occasion') {
                const evt = document.getElementById('occasionEvent').value;
                const req = document.getElementById('occasionType').value;
                systemPrompt += " ä»»åŠ¡ï¼šæ§ŸåŸæœ¬åœ°ç­–åˆ’ã€‚å¦»èº«ä½“ä¸é€‚ï¼Œé€‰èˆ’é€‚åœ°ç‚¹ã€‚**æ¨èé¤å…å¿…é¡»åŒ…å« Maps é“¾æ¥å’Œç”µè¯(å¦‚æœ‰)**ã€‚";
                prompt = `èŠ‚æ—¥ï¼š${evt}ã€‚éœ€æ±‚ï¼š${req}ã€‚`;
            }
            else if (type === 'message') {
                const ctx = document.getElementById('msgContext').value;
                systemPrompt += " ä»»åŠ¡ï¼šç®€çŸ­å¾®ä¿¡ï¼ˆ50å­—å†…ï¼‰+ å¾®è¡ŒåŠ¨ã€‚";
                if (ctx === 'health_care') prompt = "å¦»å­ä¸èˆ’æœã€‚å†™å…³å¿ƒå¾®ä¿¡+æš–å¿ƒè¡ŒåŠ¨ã€‚";
                else prompt = `åœºæ™¯ï¼š${ctx}ã€‚`;
            }
            else if (type === 'humor') {
                const t = document.getElementById('humorType').value;
                if(t === 'marriage_life') prompt = "å…³äºç»“å©š7å¹´å¤«å¦»ç”Ÿæ´»çš„å¹½é»˜åæ§½ã€‚";
                if(t === 'parenting_kid') prompt = "å…³äºå¸¦6å²å„¿å­çš„å´©æºƒå¥½ç¬‘ç¬é—´ã€‚";
                if(t === 'penang_style') prompt = "æ§ŸåŸä¸“å±ç¬‘è¯ (Hokkien style context)ã€‚";
                if(t === 'relaxing') prompt = "çº¯æ”¾æ¾å†·ç¬‘è¯ã€‚";
            }
            else if (type === 'deeptalk') {
                const vibe = document.getElementById('topicVibe').value;
                prompt = `èŠå¤©è¯é¢˜ã€‚æ°›å›´ï¼š${vibe}ã€‚`;
            }
            else if (type === 'booster') {
                const goal = document.getElementById('boosterGoal').value;
                if(goal === 'aftercare') prompt = "æ€§çˆ±åé©¬ä¸Šåšå“ª3ä»¶å°äº‹ï¼Ÿ";
                if(goal === 'during_sex_talk') prompt = "æ€§çˆ±ä¸­èŠä»€ä¹ˆï¼Ÿç»™3ä¸ªè¯æœ¯ã€‚";
                if(goal === 'passive_to_active') prompt = "å¦‚ä½•è®©å¥¹ä¸»åŠ¨ï¼Ÿå»ºè®®ã€‚";
            }
            else if (type === 'apology') {
                const r = document.getElementById('apologyType').value;
                if(r === 'forgot_task') prompt = "å¿˜äº¤ä»£çš„äº‹ã€‚é“æ­‰+è¡¥æ•‘ã€‚";
                if(r === 'too_slow') prompt = "åŠ¨ä½œæ…¢ã€‚å®‰æŠš+æ•ˆç‡ã€‚";
                if(r === 'bad_temper') prompt = "è„¾æ°”ä¸å¥½ã€‚ç ´å†°+æ¶ˆæ°”ã€‚";
                if(r === 'ignored_msg') prompt = "å¿½ç•¥ä¿¡æ¯ã€‚è§£é‡Š+è¡¥å¿ã€‚";
            }
            else if (type === 'surprise') {
                const c = document.getElementById('surpriseContext').value;
                prompt = `åœºæ™¯ï¼š${c}ã€‚æƒŠå–œç‚¹å­ã€‚`;
            }
            else if (type === 'warmth') {
                prompt = "ä»Šå¤©å¯ä»¥åšçš„éæ€§æ¥è§¦æ¸©é¦¨å°äº’åŠ¨ï¼ˆç…§é¡¾æ€§è´¨ï¼‰ã€‚";
            }
            else if (type === 'distance') {
                const c = document.getElementById('distanceContext').value;
                prompt = `åœºæ™¯ï¼š${c}ã€‚ä¸ˆå¤«å¸¦å¨ƒï¼Œå¦»åœ¨å¤–åœ°ã€‚å†™å¾®ä¿¡ã€‚`;
            }
            else if (type === 'reunion') {
                const g = document.getElementById('reunionGoal').value;
                prompt = `31å·Sunway Carnivalæ¥å¦»ã€‚ç›®æ ‡ï¼š${g}ã€‚åŒ…å«å…·ä½“åº—åé“¾æ¥ã€‚`;
            }

            // Retry Logic
            let attempts = 0;
            const maxAttempts = 3;
            let success = false;

            while(attempts < maxAttempts && !success) {
                try {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`;
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } })
                    });
                    
                    if(res.status === 429) throw new Error("QUOTA");
                    const data = await res.json();
                    if(data.error) throw new Error(data.error.message);

                    const mdText = data.candidates?.[0]?.content?.parts?.[0]?.text || "AI æš‚æ—¶æ²‰é»˜";
                    if (type === 'deeptalk') contentBox.innerText = mdText;
                    else contentBox.innerHTML = marked.parse(mdText);

                    resultBox.classList.remove('hidden');
                    success = true;
                } catch (e) {
                    attempts++;
                    if(e.message.includes("QUOTA") || e.message.includes("429")) {
                        if (attempts === maxAttempts) alert("API ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•ã€‚");
                        else await new Promise(r => setTimeout(r, 2000 * attempts));
                    } else {
                        alert("é”™è¯¯: " + e.message);
                        break;
                    }
                }
            }

            if(loadingSpinner) loadingSpinner.classList.add('hidden');
            btn.disabled = false;
            if(!loadingSpinner) { 
                const originalText = btn.getAttribute('data-original-text') || "ç”Ÿæˆ"; 
                btn.innerHTML = originalText;
            }
        }

        // Countdown
        function updateCount() {
            const t = new Date("2025-12-31T18:00:00").getTime();
            const n = new Date().getTime();
            const d = t - n;
            document.getElementById("countdownTimer").innerText = (d < 0 ? 0 : Math.floor(d / (1000 * 60 * 60 * 24)) + 1) + "å¤©";
        }
        updateCount();
    </script>
</body>
</html>