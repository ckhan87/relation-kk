<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harmony V20 (Multi-Key)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* åŸºç¡€è®¾ç½® */
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #F8FAFC; color: #334155; -webkit-tap-highlight-color: transparent; }
        
        /* å¡ç‰‡è®¾è®¡ */
        .section-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; padding-left: 0.25rem; }
        .section-title { font-weight: 900; font-size: 1.125rem; color: #1e293b; }
        
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); padding: 1.25rem; border: 1px solid #e2e8f0; transition: transform 0.1s; position: relative; overflow: hidden; margin-bottom: 1rem; }
        .card:active { transform: scale(0.995); }
        .card::before { content: ''; position: absolute; top: 0; left: 0; width: 6px; height: 100%; }
        
        /* é¢œè‰²åˆ†ç±» */
        .card-health::before { background-color: #10b981; } /* Emerald */
        .card-love::before { background-color: #ec4899; } /* Pink */
        .card-bridge::before { background-color: #8b5cf6; } /* Violet */
        .card-spark::before { background-color: #f59e0b; } /* Amber */
        .card-sex::before { background-color: #f43f5e; } /* Rose */
        .card-life::before { background-color: #06b6d4; } /* Cyan */
        
        /* æŒ‰é’® */
        .btn { font-weight: 700; padding: 0.875rem; border-radius: 0.75rem; width: 100%; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 0.5rem; font-size: 0.95rem; }
        .btn-health { background-color: #ecfdf5; color: #047857; border: 1px solid #a7f3d0; }
        .btn-love { background-color: #fdf2f8; color: #be185d; border: 1px solid #fbcfe8; }
        .btn-bridge { background-color: #f5f3ff; color: #7c3aed; border: 1px solid #ddd6fe; } 
        .btn-spark { background-color: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
        .btn-sex { background-color: #fff1f2; color: #e11d48; border: 1px solid #fda4af; }
        .btn-life { background-color: #ecfeff; color: #0e7490; border: 1px solid #a5f3fc; }
        
        /* é¢„è§ˆåŒº */
        .preview-box { margin-top: 1rem; padding: 1rem; border-radius: 0.75rem; background: #f8fafc; border: 1px dashed #cbd5e1; cursor: pointer; position: relative; }
        .click-hint { position: absolute; top: -10px; right: 10px; background: #334155; color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 99px; font-weight: bold; }

        /* é»„è‰²é«˜äº® */
        mark { background-color: #fef9c3; color: #854d0e; padding: 2px 6px; border-radius: 4px; font-weight: 600; border: 1px dashed #fde047; }

        /* é˜…è¯»å™¨ */
        #reader-modal { position: fixed; inset: 0; z-index: 100; background: white; transform: translateY(100%); transition: transform 0.25s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; }
        #reader-modal.open { transform: translateY(0); }
        #reader-content { flex: 1; overflow-y: auto; padding: 1.5rem; padding-bottom: 6rem; }
        
        .prose { font-size: 1.2rem; line-height: 1.75; color: #334155; }
        .prose h3 { font-size: 1.4rem; font-weight: 800; color: #0f172a; margin-top: 1.5em; margin-bottom: 0.5em; }
        .prose ul { padding-left: 0; list-style: none; }
        .prose li { margin-bottom: 1rem; position: relative; padding-left: 1.5rem; }
        .prose li::before { content: "â†’"; position: absolute; left: 0; color: #94a3b8; font-weight: bold; }
        .spinner { width: 18px; height: 18px; border: 3px solid currentColor; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 90; backdrop-filter: blur(4px); }
    </style>
</head>
<body class="pb-32">

    <!-- Header -->
    <header class="bg-white/90 backdrop-blur sticky top-0 z-40 border-b border-slate-200 px-5 py-4 flex justify-between items-center">
        <div>
            <h1 class="font-black text-xl text-slate-800 tracking-tight">Harmony V20</h1>
            <p class="text-xs text-slate-400 font-medium">Multi-Key Stable</p>
        </div>
        <button onclick="openKeyModal()" class="text-xs font-bold text-slate-500 bg-slate-100 px-3 py-2 rounded-lg">âš™ï¸ è®¾ç½®</button>
    </header>

    <main class="max-w-md mx-auto px-4 mt-6 space-y-10">

        <!-- ZONE 1: å¥åº· (SOS) -->
        <section>
            <div class="section-header">
                <span class="text-2xl">ğŸ¥</span>
                <h2 class="section-title text-emerald-700">å¥åº·æ€¥æ•‘åŒ… (Health)</h2>
            </div>
            <div class="card card-health">
                <p class="text-xs text-slate-500 mb-3 font-medium">å¥¹èº«ä½“ä¸é€‚æ—¶...</p>
                <select id="healthIssue" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none mb-3 font-medium text-slate-700">
                    <option value="period">ğŸ©¸ ç»æœŸï¼šç—›ç»/è…°é…¸</option>
                    <option value="neck_pain">ğŸ¦’ é¢ˆæ¤ï¼šé•¿æœŸé…¸ç—›</option>
                    <option value="constipation">ğŸš½ è‚ èƒƒï¼šä¾¿ç§˜å›°æ‰°</option>
                    <option value="bloating">ğŸ¡ è‚ èƒƒï¼šèƒƒèƒ€æ°”</option>
                    <option value="headache">ğŸ¤• å¤´éƒ¨ï¼šåå¤´ç—›</option>
                </select>
                <button onclick="runGemini('healthcare')" class="btn btn-health">
                    <span>ğŸš‘ è·å–æŠ¤ç†æŒ‡å—</span>
                    <div id="loading-healthcare" class="spinner hidden"></div>
                </button>
                <div id="result-healthcare" class="preview-box hidden" onclick="openReader(this)">
                    <div class="click-hint">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
                    <div id="content-healthcare" class="line-clamp-3 text-sm text-slate-600"></div>
                </div>
            </div>
        </section>

        <!-- ZONE 2: å®‰å…¨æ„Ÿ (Zero Pressure) -->
        <section>
            <div class="section-header">
                <span class="text-2xl">â˜ï¸</span>
                <h2 class="section-title text-violet-700">æ— å‹äº²å¯† (Safe Zone)</h2>
            </div>
            <div class="card card-bridge">
                <p class="text-xs text-slate-500 mb-3 font-medium">å•çº¯è¡¨è¾¾çˆ±æ„ï¼Œæ˜ç¡®ä»Šå¤©â€œä¸åšçˆ±â€ã€‚</p>
                <select id="nopressureContext" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none mb-3 font-medium text-slate-700">
                    <option value="morning_routine">â˜€ï¸ æ—©æ™¨/å‡ºé—¨å‰</option>
                    <option value="sofa_relax">ğŸ›‹ï¸ æ™šä¸Šæ²™å‘æ—¶é—´</option>
                    <option value="bedtime_cuddle">ğŸŒ™ ç¡å‰æ‹¥æŠ± (çº¯ç¡è§‰)</option>
                    <option value="helping_hand">ğŸ¤² åšå®¶åŠ¡æ—¶</option>
                    <option value="tired_support">ğŸ”‹ å¥¹å¾ˆç´¯æ—¶</option>
                </select>
                <button onclick="runGemini('nopressure')" class="btn btn-bridge">
                    <span>ğŸ›¡ï¸ è·å–"å…æ­»é‡‘ç‰Œ"åŠ¨ä½œ</span>
                    <div id="loading-nopressure" class="spinner hidden"></div>
                </button>
                <div id="result-nopressure" class="preview-box hidden" onclick="openReader(this)">
                    <div class="click-hint">ç‚¹å‡»æŸ¥çœ‹</div>
                    <div id="content-nopressure" class="line-clamp-3 text-sm text-slate-600"></div>
                </div>
            </div>
        </section>

        <!-- ZONE 2.5: å¿ƒåŠ¨å¼•ç‡ƒ (Desire Spark) -->
        <section>
            <div class="section-header">
                <span class="text-2xl">ğŸ’“</span>
                <h2 class="section-title text-amber-600">å¿ƒåŠ¨å¼•ç‡ƒ (Desire Spark)</h2>
            </div>
            <div class="card card-spark">
                <p class="text-xs text-slate-500 mb-3 font-medium">å”¤é†’æ¸´æœ›ï¼šæ— å‹åŠ›è¯æœ¯ + å¾®åŠ¨ä½œã€‚</p>
                <select id="sparkContext" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none mb-3 font-medium text-slate-700">
                    <option value="praise_charm">âœ¨ èµç¾é­…åŠ›ï¼šè®©å¥¹è§‰å¾—è‡ªå·±å¾ˆè¿·äºº</option>
                    <option value="serving_tease">ğŸ’† æœåŠ¡æ’©æ‹¨ï¼šå¹å¤´/æŒ‰æ‘©æ—¶çš„å¼ åŠ›</option>
                    <option value="eye_contact">ğŸ‘€ çœ¼ç¥ä¸æ°›å›´ï¼šæ— å£°èƒœæœ‰å£°</option>
                    <option value="gratitude_love">ğŸŒ¹ æ·±æƒ…è‚¯å®šï¼šè®©å¥¹æ„ŸåŠ¨åˆ°æƒ³å›æŠ¥</option>
                </select>
                <button onclick="runGemini('spark')" class="btn btn-spark">
                    <span>ğŸ”¥ ç‚¹ç‡ƒå¿ƒä¸­æ¸´æœ›</span>
                    <div id="loading-spark" class="spinner hidden"></div>
                </button>
                <div id="result-spark" class="preview-box hidden" onclick="openReader(this)">
                    <div class="click-hint">ç‚¹å‡»æŸ¥çœ‹</div>
                    <div id="content-spark" class="line-clamp-3 text-sm text-slate-600"></div>
                </div>
            </div>
        </section>

        <!-- ZONE 3: å…³ç³»å‡æ¸© (Connection) -->
        <section>
            <div class="section-header">
                <span class="text-2xl">ğŸ’Œ</span>
                <h2 class="section-title text-pink-700">å…³ç³»å‡æ¸© (Connection)</h2>
            </div>
            
            <!-- Message -->
            <div class="card card-love mb-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-slate-800">æš–å¿ƒä¿¡ä½¿ Pro</h3>
                    <span class="text-[10px] bg-pink-100 text-pink-600 px-2 py-0.5 rounded font-bold">3ç§é£æ ¼</span>
                </div>
                <select id="msgContext" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none mb-3">
                    <option value="post_sex_cold">ğŸ›Œ è´¤è€…æ—¶é—´ (æ‰“ç ´å†·æ·¡)</option>
                    <option value="wife_stressed_work">ğŸ¤¯ å¥¹å‹åŠ›å¤§ (æ”¯æŒ)</option>
                    <option value="wfh_lunch">ğŸ  WFH åˆé—´ (ç ´å†°)</option>
                    <option value="apology_ignore">ğŸ˜“ å¿½ç•¥äº†å¥¹ (è¡¥æ•‘)</option>
                    <option value="random_love">ğŸ’– æ—¥å¸¸æ’©æ‹¨ (éšæœº)</option>
                </select>
                <button onclick="runGemini('message')" class="btn btn-love">
                    <span>âœ¨ ç”Ÿæˆ 3 ä¸ªé€‰é¡¹</span>
                    <div id="loading-message" class="spinner hidden"></div>
                </button>
                <div id="result-message" class="preview-box hidden" onclick="openReader(this)">
                    <div class="click-hint">ç‚¹å‡»å…¨å±é€‰æ‹©</div>
                    <div id="content-message" class="line-clamp-3 text-sm text-slate-600"></div>
                </div>
            </div>

            <!-- Deep Talk -->
            <div class="card card-love">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-slate-800">æ·±åº¦è¯é¢˜åº“</h3>
                </div>
                <select id="topicVibe" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none mb-3">
                    <option value="relaxed">ğŸŒ™ ç¡å‰è½»æ¾ (Fun)</option>
                    <option value="nostalgic">ğŸ“¸ æ€€æ—§å›å¿† (Memory)</option>
                    <option value="future">ğŸš€ æœªæ¥æ¢¦æƒ³ (Dreams)</option>
                    <option value="appreciation">ğŸ™ äº’ç›¸æ„Ÿè°¢ (Gratitude)</option>
                </select>
                <button onclick="runGemini('deeptalk')" class="btn btn-love">
                    <span>ğŸ—£ï¸ æ¥ä¸ªæ–°è¯é¢˜</span>
                    <div id="loading-deeptalk" class="spinner hidden"></div>
                </button>
                <div id="result-deeptalk" class="preview-box hidden" onclick="openReader(this)">
                    <div class="click-hint">ç‚¹å‡»æŸ¥çœ‹</div>
                    <div id="content-deeptalk" class="line-clamp-3 text-sm text-slate-600"></div>
                </div>
            </div>
        </section>

        <!-- ZONE 4: æ€§çˆ±å®æˆ˜ (Intimacy) -->
        <section>
            <div class="section-header">
                <span class="text-2xl">ğŸ”¥</span>
                <h2 class="section-title text-rose-700">æ€§çˆ±å®æˆ˜ (Intimacy)</h2>
            </div>
            <div class="card card-sex">
                <p class="text-xs text-slate-500 mb-3 font-medium">åŸç† + æ­¥éª¤ + è¯æœ¯ (é™„é«˜äº®)</p>
                <select id="boosterGoal" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none mb-3">
                    <option value="sensitive_ears">ğŸ‘‚ æ•æ„Ÿå¸¦ï¼šè€³æœµ (æŠ—æ‹’ç›´æ¥æ‘¸)</option>
                    <option value="aftercare">ğŸ›Œ æ€§çˆ±åï¼šè®©å¿ƒæ›´é¥±æ»¡ (Aftercare)</option>
                    <option value="during_sex_talk">ğŸ’¬ æ€§çˆ±ä¸­ï¼šèŠä»€ä¹ˆ (Dirty Talk)</option>
                    <option value="passive_to_active">ğŸ’ƒ é•¿æœŸï¼šè®©å¥¹å˜ä¸»åŠ¨ (Seduction)</option>
                    <option value="foreplay_daily">ğŸ”¥ æ—¥å¸¸å‰æˆ (Foreplay)</option>
                </select>
                <button onclick="runGemini('booster')" class="btn btn-sex">
                    <span>ğŸŒ¶ï¸ è·å–æ–°æ”»ç•¥</span>
                    <div id="loading-booster" class="spinner hidden"></div>
                </button>
                <div id="result-booster" class="preview-box hidden" onclick="openReader(this)">
                    <div class="click-hint">ç‚¹å‡»é˜…è¯»æ”»ç•¥</div>
                    <div id="content-booster" class="line-clamp-3 text-sm text-slate-600"></div>
                </div>
            </div>
        </section>

        <!-- ZONE 5: ç”Ÿæ´» (Life) -->
        <section>
            <div class="section-header">
                <span class="text-2xl">ğŸ§©</span>
                <h2 class="section-title text-cyan-700">ç”Ÿæ´»è°ƒå‘³ (Life)</h2>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div class="card card-life flex flex-col justify-between">
                    <div>
                        <h3 class="font-bold text-sm text-slate-800 mb-2">ğŸš‘ ç´§æ€¥æ•‘ç«</h3>
                        <select id="apologyType" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-xs outline-none mb-2">
                            <option value="forgot_task">ğŸ§  å¿˜äº‹</option>
                            <option value="bad_temper">ğŸ’¥ è„¾æ°”å</option>
                            <option value="too_slow">ğŸ¢ åŠ¨ä½œæ…¢</option>
                        </select>
                    </div>
                    <button onclick="runGemini('apology')" class="btn btn-life text-xs py-2">
                        <span>æ±‚ç”ŸæŒ‡å—</span>
                        <div id="loading-apology" class="spinner hidden w-3 h-3"></div>
                    </button>
                    <div id="result-apology" class="hidden"><div id="content-apology"></div></div>
                </div>

                <div class="card card-life flex flex-col justify-between">
                    <div>
                        <h3 class="font-bold text-sm text-slate-800 mb-2">ğŸ˜„ æ¯æ—¥ä¸€ç¬‘</h3>
                        <select id="humorType" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-xs outline-none mb-2">
                            <option value="marriage_life">ğŸ‘« å¤«å¦»æ§½ç‚¹</option>
                            <option value="parenting_kid">ğŸ‘¶ å¸¦å¨ƒå´©æºƒ</option>
                            <option value="penang_style">ğŸœ Penang Style</option>
                        </select>
                    </div>
                    <button onclick="runGemini('humor')" class="btn btn-life text-xs py-2">
                        <span>æ¥ä¸ªæ®µå­</span>
                        <div id="loading-humor" class="spinner hidden w-3 h-3"></div>
                    </button>
                    <div id="result-humor" class="hidden"><div id="content-humor"></div></div>
                </div>
            </div>
        </section>

        <!-- ZONE 6: ç‰¹æ®Šä»»åŠ¡ -->
        <section class="opacity-80 hover:opacity-100 transition-opacity pt-4 border-t border-slate-200">
            <div class="section-header">
                <span class="text-xl">ğŸ“…</span>
                <h2 class="font-bold text-slate-500 text-base">é‡é€¢ & å¼‚åœ°</h2>
            </div>
            <div class="flex gap-2 overflow-x-auto pb-2">
                <div class="flex-shrink-0 w-40 bg-white p-3 rounded-xl border border-slate-200">
                    <div class="text-xs font-bold text-indigo-600 mb-1">âœˆï¸ å¼‚åœ°ä¼ æƒ…</div>
                    <select id="distanceContext" class="w-full text-xs mb-2 bg-slate-50 rounded"><option value="son_update">ğŸ“¸ å„¿å­å¾ˆä¹–</option><option value="miss_you_night">ğŸŒ™ æ™šä¸Šæƒ³ä½ </option></select>
                    <button onclick="runGemini('distance')" class="w-full bg-indigo-50 text-indigo-600 text-xs font-bold py-1 rounded">ç”Ÿæˆ</button>
                    <div id="result-distance" class="hidden"><div id="content-distance"></div></div>
                </div>
                <div class="flex-shrink-0 w-40 bg-white p-3 rounded-xl border border-slate-200">
                    <div class="text-xs font-bold text-indigo-600 mb-1">ğŸ¡ 31å·ç­–åˆ’</div>
                    <select id="reunionGoal" class="w-full text-xs mb-2 bg-slate-50 rounded"><option value="dinner_talk">ğŸ½ï¸ æ™šé¤è¯é¢˜</option><option value="movie_touch">ğŸ¬ å°åŠ¨ä½œ</option></select>
                    <button onclick="runGemini('reunion')" class="w-full bg-indigo-50 text-indigo-600 text-xs font-bold py-1 rounded">ç”Ÿæˆ</button>
                    <div id="result-reunion" class="hidden"><div id="content-reunion"></div></div>
                </div>
            </div>
        </section>

    </main>

    <!-- FULL SCREEN READER -->
    <div id="reader-modal">
        <div class="flex justify-between items-center px-6 py-4 border-b border-slate-100 bg-white sticky top-0 z-50">
            <span class="font-bold text-lg text-slate-800">é˜…è¯»æ¨¡å¼</span>
            <button onclick="closeReader()" class="bg-slate-100 text-slate-500 w-8 h-8 rounded-full font-bold">âœ•</button>
        </div>
        <div id="reader-content" class="prose"></div>
    </div>

    <!-- API KEY MODAL -->
    <div id="key-modal" class="hidden modal-bg flex items-center justify-center">
        <div class="bg-white p-6 rounded-2xl w-11/12 max-w-sm shadow-2xl">
            <h3 class="font-bold text-slate-800 text-lg mb-2">è®¾ç½® API Key</h3>
            <p class="text-xs text-slate-500 mb-3">ç³»ç»Ÿå·²å†…ç½® 3 ç»„é«˜é€Ÿ Keyï¼Œè‡ªåŠ¨åˆ‡æ¢ã€‚</p>
            <p class="text-xs text-slate-500 mb-1 font-bold">æ‰‹åŠ¨è¦†ç›– (å¯é€‰):</p>
            <input type="text" id="custom-api-key" placeholder="AIza..." class="w-full border p-2 rounded-lg mb-4 text-sm">
            <div class="flex gap-2">
                <button onclick="closeKeyModal()" class="flex-1 py-2 text-slate-500">å–æ¶ˆ</button>
                <button onclick="saveCustomKey()" class="flex-1 py-2 bg-slate-800 text-white rounded-lg font-bold">ä¿å­˜</button>
            </div>
            <button onclick="clearCustomKey()" class="w-full mt-4 text-xs text-red-400">æ¢å¤ç³»ç»Ÿé»˜è®¤</button>
        </div>
    </div>

    <script>
        // --- KEY SYSTEM (MULTI-KEY POOL) ---
        const SYSTEM_KEYS = [
            "AIzaSyClDjCuLE2RpWL5v1A2DQQ0j2gnFd6p_Vg",
            "AIzaSyAS8Tf9Gbd_FWXq1CWalOILhuPODjluvJI",
            "AIzaSyCinhRhthd9YQF1AbZ_gaEMxa_PkgcBsr8"
        ];
        
        function openKeyModal() { document.getElementById("key-modal").classList.remove("hidden"); }
        function closeKeyModal() { document.getElementById("key-modal").classList.add("hidden"); }
        function saveCustomKey() {
            const input = document.getElementById("custom-api-key").value.trim();
            if(!input.startsWith("AIza")) return alert("æ ¼å¼é”™è¯¯");
            localStorage.setItem("my_custom_key", input);
            closeKeyModal();
            alert("å·²ä¿å­˜æ‚¨çš„ä¸“å± Keyï¼");
        }
        function clearCustomKey() {
            localStorage.removeItem("my_custom_key");
            closeKeyModal();
            alert("å·²æ¢å¤åˆ°ç³»ç»Ÿè‡ªåŠ¨ Key æ± ");
        }

        function openReader(el) {
            const contentId = el.id.replace('result-', 'content-');
            const contentHtml = document.getElementById(contentId).innerHTML;
            if(contentHtml) {
                document.getElementById('reader-content').innerHTML = contentHtml;
                document.getElementById('reader-modal').classList.add('open');
                document.body.style.overflow = 'hidden';
            }
        }
        function closeReader() {
            document.getElementById('reader-modal').classList.remove('open');
            document.body.style.overflow = '';
        }

        // --- GEMINI CORE WITH MULTI-KEY FAILOVER ---
        async function runGemini(type) {
            const btn = document.querySelector(`button[onclick="runGemini('${type}')"]`);
            const spinner = document.getElementById(`loading-${type}`);
            const resultBox = document.getElementById(`result-${type}`);
            const contentBox = document.getElementById(`content-${type}`);

            spinner.classList.remove('hidden');
            btn.disabled = true;
            btn.querySelector('span').style.opacity = '0.5';
            if(resultBox) resultBox.classList.add('hidden');

            // 1. Prepare Keys: Custom Key (if any) -> System Key 1 -> System Key 2 -> System Key 3
            let keysToTry = [...SYSTEM_KEYS];
            const customKey = localStorage.getItem("my_custom_key");
            if(customKey) keysToTry.unshift(customKey); // Put custom key first

            // --- PROMPTS ---
            let systemPrompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ä¸¤æ€§å…³ç³»ä¸å¥åº·ç”Ÿæ´»é¡¾é—®ã€‚
            ç”¨æˆ·ï¼š38å²ä¸ˆå¤«ï¼ŒPenang Simpang Ampatã€‚å¦»37å²ï¼ˆæ…¢çƒ­ï¼‰ã€‚
            **æ ¸å¿ƒæŒ‡ä»¤**ï¼š
            1. **æ— åœ°å€é“¾æ¥**ï¼šä¸è¦æ¨èåº—é“ºé“¾æ¥ã€‚
            2. **é»„è‰²é«˜äº®**ï¼šå¯¹è¯ç¤ºä¾‹ã€å…³é”®è¯æœ¯ç”¨ \`<mark>\` åŒ…è£¹ã€‚
            3. **æ¯æ¬¡ä¸åŒ**ï¼šç”Ÿæˆæ–°é¢–å»ºè®®ï¼Œä¸è¦é‡å¤ã€‚
            4. **æ ¼å¼**ï¼šMarkdownï¼Œåˆ—è¡¨ï¼Œæ¸…æ™°ã€‚`;

            let prompt = `éšæœºç§å­ï¼š${Math.random()}ã€‚`; 

            // HEALTH
            if (type === 'healthcare') {
                const issue = document.getElementById('healthIssue').value;
                systemPrompt += " ä»»åŠ¡ï¼šèº«ä½“ä¸é€‚æŠ¤ç†ã€‚";
                if(issue === 'period') prompt += "å¥¹æ¥æœˆäº‹ã€‚1.æš–å¿ƒè¯æœ¯ã€‚2.è¡ŒåŠ¨æŒ‡å—ã€‚3.æŒ‰æ‘©æ‰‹æ³•ã€‚";
                if(issue === 'neck_pain') prompt += "å¥¹é¢ˆé¡¹é…¸ç—›ã€‚1.ç¼“è§£åŠ¨ä½œã€‚2.ç”Ÿæ´»å»ºè®®ã€‚3.å®‰æŠšè¯æœ¯ã€‚";
                if(issue === 'constipation') prompt += "å¥¹ä¾¿ç§˜ã€‚1.é¥®é£Ÿå»ºè®®ï¼ˆPenangæ°´æœï¼‰ã€‚2.è…¹éƒ¨æŒ‰æ‘©ã€‚";
                if(issue === 'bloating') prompt += "å¥¹èƒƒèƒ€æ°”ã€‚1.ç´§æ€¥å§¿åŠ¿ã€‚2.é¥®å“ã€‚";
                if(issue === 'headache') prompt += "å¥¹å¤´ç—›ã€‚1.é™å…»ã€‚2.å¤´éƒ¨æŒ‰æ‘©ã€‚";
            }
            // NO PRESSURE
            else if (type === 'nopressure') {
                const ctx = document.getElementById('nopressureContext').value;
                systemPrompt += " ä»»åŠ¡ï¼š**æ— å‹äº²å¯†**ã€‚ç›®æ ‡æ˜¯å®‰å…¨æ„Ÿï¼Œ**æ˜ç¡®ä¼ è¾¾ä»Šå¤©ä¸åšçˆ±**ã€‚";
                prompt += `åœºæ™¯ï¼š${ctx}ã€‚3ä¸ªå¾®åŠ¨ä½œã€‚
                å«ï¼šå…·ä½“åŠ¨ä½œã€å®šå¿ƒä¸¸è¯æœ¯(<mark>é«˜äº®</mark>)ã€å¿ƒç†åŸç†ã€‚`;
            }
            // SPARK (NEW)
            else if (type === 'spark') {
                const ctx = document.getElementById('sparkContext').value;
                systemPrompt += " ä»»åŠ¡ï¼š**å¿ƒåŠ¨å¼•ç‡ƒ**ã€‚ç›®æ ‡æ˜¯**è®©å¥¹çš„å¿ƒæ»¡æ»¡çš„ï¼Œè‡ªç„¶äº§ç”Ÿæ¸´æœ›**ã€‚";
                prompt += `åœºæ™¯ï¼š${ctx}ã€‚3ä¸ªé«˜é˜¶æŠ€å·§ã€‚
                å«ï¼šå¿ƒåŠ¨è¯æœ¯(<mark>é«˜äº®</mark>)ã€å¾®åŠ¨ä½œã€åŸç†ã€‚`;
            }
            // MESSAGE
            else if (type === 'message') {
                const ctx = document.getElementById('msgContext').value;
                prompt += `åœºæ™¯ï¼š${ctx}ã€‚**3ä¸ªä¸åŒé£æ ¼**å¾®ä¿¡æ–‡æ¡ˆ+é…å¥—è¡ŒåŠ¨ã€‚è¯æœ¯<mark>é«˜äº®</mark>ã€‚`;
            }
            // DEEP TALK
            else if (type === 'deeptalk') {
                const vibe = document.getElementById('topicVibe').value;
                prompt += `æ°›å›´ï¼š${vibe}ã€‚é«˜è´¨é‡è¯é¢˜+2ä¸ªè¿½é—®ã€‚å†…å®¹<mark>é«˜äº®</mark>ã€‚`;
            }
            // BOOSTER
            else if (type === 'booster') {
                const goal = document.getElementById('boosterGoal').value;
                systemPrompt += " ä»»åŠ¡ï¼šæ€§å¿ƒç†å®æˆ˜æ”»ç•¥ã€‚";
                if(goal === 'sensitive_ears') prompt += "å¦»è€³æœµæ•æ„ŸæŠ—æ‹’æ‘¸ã€‚1.è„±æ•åŸç†ã€‚2.è¾¹ç¼˜è¯•æ¢(å‘¼å¸/å¤´å‘)ã€‚3.å¼•å¯¼è¯æœ¯(<mark>é«˜äº®</mark>)ã€‚";
                else if(goal === 'aftercare') prompt += "æ€§çˆ±åAfterglowã€‚1.ç¬¬ä¸€å¥è¯ã€‚2.è‚¢ä½“åŠ¨ä½œã€‚3.èµç¾ã€‚è¯æœ¯<mark>é«˜äº®</mark>ã€‚";
                else if(goal === 'during_sex_talk') prompt += "æ€§çˆ±ä¸­èŠä»€ä¹ˆï¼Ÿ3ä¸ªå±‚çº§è¯æœ¯ï¼Œ<mark>é«˜äº®</mark>ã€‚";
                else if(goal === 'passive_to_active') prompt += "è®©å¥¹å˜ä¸»åŠ¨ï¼ŸåŸç†+å¸ƒå±€+å¼•å¯¼è¯æœ¯(<mark>é«˜äº®</mark>)ã€‚";
                else if(goal === 'foreplay_daily') prompt += "æ—¥å¸¸å‰æˆã€‚3ä¸ªä¸éœ²éª¨ä½†æœ‰å¼ åŠ›çš„äº’åŠ¨ã€‚";
            }
            // OTHERS
            else if (type === 'apology') {
                const r = document.getElementById('apologyType').value;
                prompt += `å› ä¸º${r}æƒ¹å¥¹ç”Ÿæ°”ã€‚1.é“æ­‰è¯æœ¯<mark>é«˜äº®</mark>ã€‚2.è¡¥æ•‘è¡ŒåŠ¨ã€‚3.é€—å¥¹æ¶ˆæ°”ã€‚`;
            }
            else if (type === 'humor') {
                const t = document.getElementById('humorType').value;
                prompt += `å…³äº${t}çš„ç¬‘è¯ã€‚è¦çœŸçš„å¥½ç¬‘ã€‚`;
            }
            else if (type === 'distance') {
                prompt += `å¼‚åœ°ä¼ æƒ…ã€‚3æ¡çŸ­ä¿¡ã€‚å†…å®¹<mark>é«˜äº®</mark>ã€‚`;
            }
            else if (type === 'reunion') {
                prompt += `31å·é‡é€¢ã€‚3ä¸ªå»ºè®®/è¯é¢˜ã€‚`;
            }

            // --- EXECUTE WITH FAILOVER ---
            let success = false;
            let finalError = null;

            for (const key of keysToTry) {
                try {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } })
                    });
                    
                    if(res.status !== 200) throw new Error(`API Error: ${res.status}`);
                    
                    const data = await res.json();
                    if(data.error) throw new Error(data.error.message);
                    
                    const mdText = data.candidates?.[0]?.content?.parts?.[0]?.text || "AI æ€è€ƒä¸­...";
                    
                    // Success! Render and break loop
                    contentBox.innerHTML = marked.parse(mdText);
                    
                    if(['apology', 'humor', 'distance', 'reunion', 'nopressure', 'spark'].includes(type)) {
                        document.getElementById('reader-content').innerHTML = marked.parse(mdText);
                        document.getElementById('reader-modal').classList.add('open');
                        document.body.style.overflow = 'hidden';
                    } else {
                        resultBox.classList.remove('hidden');
                    }
                    
                    success = true;
                    break; // STOP LOOP

                } catch (e) {
                    console.warn(`Key failed, trying next...`, e);
                    finalError = e;
                    // Continue to next key
                }
            }

            if (!success) {
                alert("æ‰€æœ‰è¿æ¥å°è¯•éƒ½å¤±è´¥äº†ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚");
                console.error(finalError);
            }

            // Cleanup
            spinner.classList.add('hidden');
            btn.disabled = false;
            btn.querySelector('span').style.opacity = '1';
        }
    </script>
</body>
</html>